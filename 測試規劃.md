# 測試規劃 - 線上點餐系統

## 概述

本文檔提供完整的測試策略和實作規劃，涵蓋單元測試、整合測試、API測試和端對端測試。基於現有的代碼結構，重新規劃和實作所有測試。

## 🎯 測試目標

1. 提升代碼品質和可靠性
2. 確保多角色系統功能正常
3. 驗證核心業務邏輯
4. 防止回歸錯誤
5. 支援持續整合/部署

## 📋 測試分層策略

### 1. 單元測試 (Unit Tests) - 70%
**目標**: 測試個別函式、組件的獨立功能

#### 1.1 後端服務層測試
**優先級**: 🔴 最高
- **位置**: `tests/unit/server/services/`
- **測試框架**: Vitest
- **重點模組**:
  - `user/` - 用戶認證與管理
  - `order/` - 訂單處理邏輯
  - `promotion/` - 促銷規則計算
  - `inventory/` - 庫存管理邏輯
  - `delivery/` - 外送平台整合

**實作計劃**:
```
tests/unit/server/services/
├── user/
│   ├── userAuthService.test.js         - 用戶認證
│   ├── adminAuthService.test.js        - 管理員認證
│   └── userProfile.test.js             - 用戶資料管理
├── order/
│   ├── orderCustomer.test.js           - 顧客訂單處理
│   ├── orderAdmin.test.js              - 管理訂單處理  
│   └── orderValidation.test.js         - 訂單驗證邏輯
├── promotion/
│   ├── couponService.test.js           - 優惠券計算
│   ├── pointService.test.js            - 點數系統
│   └── voucherService.test.js          - 代金券邏輯
├── inventory/
│   ├── stockManagement.test.js         - 庫存管理
│   └── stockStats.test.js              - 庫存統計
├── delivery/
│   ├── ubereatsService.test.js         - UberEats整合
│   ├── tokenManager.test.js            - Token管理
│   └── orderSyncService.test.js        - 訂單同步
└── bundle/
    ├── bundleService.test.js           - 套餐計算
    └── bundleInstance.test.js          - 套餐實例
```

#### 1.2 前端組件測試
**優先級**: 🟡 中等
- **位置**: `tests/unit/components/`
- **測試框架**: Vitest + Vue Test Utils
- **重點組件**:

```
tests/unit/components/
├── common/                             - 共用組件
│   ├── ConfirmModal.test.js
│   └── CollapsibleSection.test.js
├── customer/                           - 顧客介面
│   ├── cart/
│   │   ├── CartItem.test.js
│   │   ├── CouponCard.test.js
│   │   └── VoucherCard.test.js
│   ├── menu/
│   │   ├── MenuItemCard.test.js
│   │   └── CategoryNavigator.test.js
│   └── auth/
│       ├── Login.test.js
│       └── Register.test.js
├── counter/                            - POS系統
│   ├── OrderCart/
│   │   ├── ShoppingCart.test.js
│   │   └── OrderDetails.test.js
│   └── modals/
│       ├── CheckoutModal.test.js
│       └── CashCalculatorModal.test.js
└── BrandAdmin/                         - 品牌管理
    ├── Order/
    │   ├── OrderList.test.js
    │   └── OrderDetailModal.test.js
    ├── Menu/
    │   ├── MenuList.test.js
    │   └── MenuForm.test.js
    └── Store/
        ├── StoreList.test.js
        └── StoreForm.test.js
```

#### 1.3 前端API模組測試
**優先級**: 🟡 中等
- **位置**: `tests/unit/api/`
- **重點**: 測試API呼叫邏輯和錯誤處理

### 2. 整合測試 (Integration Tests) - 20%
**目標**: 測試模組間的協作

#### 2.1 API路由整合測試
**優先級**: 🔴 最高
- **位置**: `tests/integration/api/`
- **測試框架**: Vitest + Supertest

```
tests/integration/api/
├── auth.integration.test.js            - 認證流程
├── order.integration.test.js           - 訂單完整流程
├── menu.integration.test.js            - 菜單管理
├── promotion.integration.test.js       - 促銷系統
├── inventory.integration.test.js       - 庫存操作
└── delivery.integration.test.js        - 外送平台整合
```

#### 2.2 資料庫整合測試
**優先級**: 🟡 中等
- **位置**: `tests/integration/database/`
- **重點**: Model關聯、事務處理

### 3. API測試 (API Tests) - 5%
**目標**: 驗證API端點正確性

#### 3.1 核心API測試
**優先級**: 🔴 最高
```
tests/api/
├── auth/                               - 認證相關
│   ├── user-login.api.test.js
│   ├── admin-login.api.test.js
│   └── password-reset.api.test.js
├── order/                              - 訂單相關
│   ├── create-order.api.test.js
│   ├── cancel-order.api.test.js
│   └── order-status.api.test.js
├── menu/                               - 菜單相關
│   ├── menu-crud.api.test.js
│   └── dish-crud.api.test.js
└── admin/                              - 管理功能
    ├── store-management.api.test.js
    └── user-management.api.test.js
```

### 4. 端對端測試 (E2E Tests) - 5%
**目標**: 模擬真實用戶操作流程

#### 4.1 關鍵用戶流程
**優先級**: 🔴 最高
- **位置**: `cypress/e2e/`
- **測試框架**: Cypress

```
cypress/e2e/
├── customer/                           - 顧客流程
│   ├── order-flow.cy.js               - 完整點餐流程
│   ├── member-registration.cy.js       - 會員註冊
│   ├── coupon-usage.cy.js             - 優惠券使用
│   └── order-history.cy.js            - 訂單歷史
├── admin/                              - 管理流程
│   ├── login.cy.js                     - 管理員登入
│   ├── store-management.cy.js          - 店舖管理
│   ├── menu-management.cy.js           - 菜單管理
│   ├── order-management.cy.js          - 訂單管理
│   └── promotion-management.cy.js      - 促銷管理
├── counter/                            - POS系統
│   ├── pos-ordering.cy.js             - POS點餐
│   ├── cash-payment.cy.js             - 現金結帳
│   └── inventory-check.cy.js          - 庫存檢查
└── boss/                              - 系統管理
    ├── brand-management.cy.js
    └── admin-user-management.cy.js
```

## 🚀 實作階段規劃

### 階段一：基礎建設 (第1-2週)
**優先級**: 🔴 最高

1. **清理現有測試**
   - 移除過時測試檔案
   - 更新測試設置檔案
   - 確認測試環境配置

2. **建立測試工具**
   - 創建測試輔助函式
   - 設置資料mock工具
   - 建立測試資料工廠

3. **核心服務測試**
   - 認證服務測試
   - 訂單核心邏輯測試
   - 庫存管理測試

### 階段二：API與整合測試 (第3-4週)
**優先級**: 🟡 中等

1. **API端點測試**
   - 認證相關API
   - 訂單相關API
   - 菜單管理API

2. **整合測試**
   - 訂單完整流程
   - 促銷系統整合
   - 外送平台整合

### 階段三：前端測試 (第5-6週)
**優先級**: 🟡 中等

1. **關鍵組件測試**
   - 購物車組件
   - 結帳流程組件
   - 管理介面組件

2. **用戶體驗測試**
   - 表單驗證
   - 錯誤處理
   - 響應式設計

### 階段四：E2E測試 (第7-8週)
**優先級**: 🟢 低等

1. **核心用戶流程**
   - 顧客點餐流程
   - 管理員操作流程
   - POS系統操作

2. **跨瀏覽器測試**
   - Chrome/Firefox/Safari
   - 行動裝置測試

## 🛠 測試工具與配置

### 測試框架選擇
- **Vitest**: 單元測試、整合測試
- **Cypress**: E2E測試
- **Vue Test Utils**: Vue組件測試
- **Supertest**: API測試

### 測試環境設置
```javascript
// tests/setup.js - 增強版
import { vi } from 'vitest'
import { createPinia } from 'pinia'
import { createI18n } from 'vue-i18n'

// 全域Mock設置
global.vi = vi
global.fetch = vi.fn()

// Vue生態系統Mock
vi.mock('vue-router', () => ({
  useRouter: () => ({
    push: vi.fn(),
    replace: vi.fn(),
    go: vi.fn()
  }),
  useRoute: () => ({
    params: {},
    query: {},
    path: '/'
  })
}))

// 測試資料工廠
export class TestDataFactory {
  static createUser() { /* ... */ }
  static createOrder() { /* ... */ }
  static createStore() { /* ... */ }
}
```

### Mock策略
1. **資料庫**: 使用MongoDB Memory Server或完全Mock
2. **外部API**: 使用MSW (Mock Service Worker)
3. **檔案系統**: Mock檔案上傳/下載
4. **時間**: Mock Date和Luxon

## 📊 測試覆蓋率目標

### 覆蓋率指標
- **整體覆蓋率**: ≥80%
- **業務邏輯**: ≥90%
- **API端點**: ≥85%
- **Vue組件**: ≥70%

### 重點監控
1. **關鍵業務流程**: 100%覆蓋
2. **錯誤處理**: 完整測試
3. **邊界條件**: 充分測試
4. **權限控制**: 完整驗證

## 📝 測試規範與最佳實踐

### 命名規則
```javascript
// 檔案命名
service.test.js      // 服務層測試
component.test.js    // 組件測試
feature.cy.js        // E2E測試

// 測試用例命名
describe('OrderService', () => {
  describe('createOrder', () => {
    it('should create order successfully with valid data', () => {
      // 測試內容
    })
    
    it('should throw error when inventory insufficient', () => {
      // 測試內容
    })
  })
})
```

### 測試結構
```javascript
// AAA模式 (Arrange, Act, Assert)
it('should calculate order total correctly', () => {
  // Arrange - 準備測試資料
  const order = TestDataFactory.createOrder({
    items: [{ price: 100, quantity: 2 }]
  })
  
  // Act - 執行測試動作
  const total = OrderService.calculateTotal(order)
  
  // Assert - 驗證結果
  expect(total).toBe(200)
})
```

## 🔧 常見問題與解決方案

### 1. Mongoose 鏈式調用 Mock 問題

**❌ 錯誤做法:**
```javascript
vi.mock('@server/models/Order/Order.js', () => ({
  default: {
    find: vi.fn().mockReturnThis(),
    sort: vi.fn().mockReturnThis(),
    skip: vi.fn().mockReturnThis(),
    limit: vi.fn().mockReturnThis(),
    lean: vi.fn()
  }
}))
```

**✅ 正確做法:**
```javascript
const mockQueryChain = () => ({
  sort: vi.fn().mockReturnThis(),
  skip: vi.fn().mockReturnThis(),
  limit: vi.fn().mockReturnThis(),
  populate: vi.fn().mockReturnThis(),
  lean: vi.fn()
})

vi.mock('@server/models/Order/Order.js', () => ({
  default: {
    countDocuments: vi.fn(),
    find: vi.fn().mockImplementation(() => mockQueryChain()),
    findOne: vi.fn().mockImplementation(() => mockQueryChain()),
    findById: vi.fn()
  }
}))
```

### 2. 動態導入順序問題

**✅ 正確順序:**
```javascript
// 1. 先設置所有 Mock
vi.mock('@server/models/Order/Order.js', () => ({ ... }))
vi.mock('@server/middlewares/error.js', () => ({ ... }))

// 2. 再動態導入服務和依賴
const orderService = await import('@server/services/order/orderCustomer.js')
const Order = (await import('@server/models/Order/Order.js')).default
const { AppError } = await import('@server/middlewares/error.js')
```

### 3. 不同類型的 Mock 策略

#### 3.1 模型實例 + 靜態方法 Mock
```javascript
const mockModel = vi.fn().mockImplementation((data) => ({
  ...data,
  _id: data._id || 'mock-id',
  save: vi.fn().mockResolvedValue(),
  deleteOne: vi.fn().mockResolvedValue()
}))

// 靜態方法
mockModel.find = vi.fn().mockReturnValue(mockQueryChain())
mockModel.findById = vi.fn()
mockModel.countDocuments = vi.fn()

vi.mock('@server/models/SomeModel.js', () => ({ default: mockModel }))
```

#### 3.2 複雜鏈式調用 Mock
```javascript
Admin.findOne.mockReturnValue({
  select: vi.fn().mockReturnValue({
    populate: vi.fn().mockReturnValue({
      populate: vi.fn().mockResolvedValue(mockAdmin)
    })
  })
})
```

### 4. AppError 處理

**✅ 推薦做法:**
```javascript
vi.mock('@server/middlewares/error.js', () => ({
  AppError: class AppError extends Error {
    constructor(message, statusCode = 500) {
      super(message)
      this.statusCode = statusCode
      this.name = 'AppError'
    }
  }
}))
```

### 5. TestDataFactory 擴展模式

```javascript
// 在測試檔案中擴展 TestDataFactory
TestDataFactory.createCouponTemplate = (overrides = {}) => {
  return {
    _id: '507f1f77bcf86cd799439020',
    name: 'Test Coupon',
    discountType: 'percentage',
    discountValue: 10,
    brandId: '507f1f77bcf86cd799439013',
    isActive: true,
    createdAt: new Date(),
    ...overrides
  }
}

// 使用 Helper 函數簡化測試資料創建
const createMockDishItem = (templateId = 'dish-1', basePrice = 100, quantity = 1) => ({
  dishInstance: {
    templateId,
    name: 'Test Dish',
    basePrice,
    finalPrice: basePrice
  },
  quantity,
  subtotal: basePrice * quantity
})
```

### 6. 前端測試特殊處理

#### 6.1 Pinia Store 設置
```javascript
beforeEach(() => {
  setActivePinia(createPinia())
  cartStore = useCartStore()
})
```

#### 6.2 Window 對象 Mock
```javascript
Object.defineProperty(window, 'sessionStorage', {
  value: {
    getItem: vi.fn(() => null),
    setItem: vi.fn(),
    removeItem: vi.fn(),
    clear: vi.fn()
  },
  writable: true
})
```

#### 6.3 API Mock
```javascript
vi.mock('@/api', () => ({
  default: {
    orderCustomer: {
      createOrder: vi.fn().mockResolvedValue({ orderId: 'test-123' })
    }
  }
}))
```

### 7. 錯誤測試最佳實踐

```javascript
// 測試錯誤拋出
await expect(
  orderService.createOrder(invalidData)
).rejects.toThrow('訂單資料無效')

// 測試錯誤類型
await expect(
  orderService.createOrder(invalidData)
).rejects.toBeInstanceOf(AppError)

// 測試錯誤訊息包含特定內容
await expect(
  orderService.createOrder(invalidData)
).rejects.toThrow(/無效的/)
```

### 8. 非同步操作處理

```javascript
// 確保 Mock 返回 Promise
mockFunction.mockResolvedValue(data)
mockFunction.mockRejectedValue(error)

// 正確使用 async/await
it('should handle async operation', async () => {
  const result = await asyncFunction()
  expect(result).toBeDefined()
})
```

### 9. 複雜對象比較

```javascript
// 使用 toMatchObject 進行部分比較
expect(result).toMatchObject({
  status: 'success',
  data: expect.any(Object)
})

// 使用 toEqual 進行完整比較
expect(result).toEqual(expectedResult)
```

### 10. 清理和重置

```javascript
beforeEach(() => {
  vi.clearAllMocks()
  // 重置特定狀態
})

afterEach(() => {
  vi.restoreAllMocks()
})
```

## 🎯 測試撰寫檢查清單

### Mock 設置檢查
- [ ] 所有外部依賴都已正確 Mock
- [ ] 鏈式調用使用 mockQueryChain 模式
- [ ] AppError 使用 class 形式
- [ ] 動態導入在 Mock 設置之後

### 測試資料檢查
- [ ] 使用 TestDataFactory 或 Helper 函數
- [ ] 測試資料具有代表性
- [ ] 邊界條件有對應的測試資料

### 測試案例檢查
- [ ] 正常情況測試
- [ ] 錯誤情況測試
- [ ] 邊界條件測試
- [ ] 權限檢查測試

### 斷言檢查
- [ ] 使用適當的 expect 方法
- [ ] 錯誤測試使用 rejects.toThrow
- [ ] 非同步操作使用 async/await

## 🔧 執行指令增強

更新 `package.json` 腳本：
```json
{
  "scripts": {
    "test": "vitest",
    "test:unit": "vitest run tests/unit",
    "test:integration": "vitest run tests/integration", 
    "test:api": "vitest run tests/api",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest --watch",
    "test:ui": "vitest --ui",
    "test:e2e": "cypress run",
    "test:e2e:open": "cypress open",
    "test:all": "yarn test:unit && yarn test:integration && yarn test:api && yarn test:e2e"
  }
}
```

## 🚦 持續整合

### GitHub Actions
```yaml
# .github/workflows/test.yml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      - name: Install dependencies
        run: yarn install
      - name: Run unit tests
        run: yarn test:unit
      - name: Run integration tests  
        run: yarn test:integration
      - name: Run E2E tests
        run: yarn test:e2e
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

## 📈 監控與報告

### 測試報告
- 使用 `vitest-sonar-reporter` 產生SonarQube報告
- 整合 `@vitest/ui` 提供視覺化測試界面
- 設置測試失敗通知

### 覆蓋率報告
- HTML報告：便於本地查看
- JSON報告：便於CI/CD整合
- 徽章顯示：README中展示覆蓋率

## 🎯 下一步行動

### 立即開始
1. **評估現有測試**: 識別可保留的測試
2. **建立基礎設施**: 更新測試設置和工具
3. **優先測試核心**: 從最重要的業務邏輯開始

### 長期維護
1. **定期檢查**: 每月檢查測試覆蓋率
2. **更新測試**: 隨功能更新同步測試
3. **性能監控**: 確保測試執行效率

---

這個測試規劃將幫助你建立一個健全、可維護的測試體系，確保代碼品質並支援持續開發。建議按照優先級逐步實作，重點先完成核心業務邏輯的測試。