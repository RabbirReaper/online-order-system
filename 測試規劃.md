# æ¸¬è©¦è¦åŠƒ - ç·šä¸Šé»é¤ç³»çµ±

## æ¦‚è¿°

æœ¬æ–‡æª”æä¾›ç·šä¸Šé»é¤ç³»çµ±çš„æ¸¬è©¦æµç¨‹æŒ‡å—ã€æŠ€è¡“è¦ç¯„å’Œå•é¡Œè§£æ±ºæ–¹æ¡ˆã€‚å°ˆæ³¨æ–¼å¯¦éš›çš„æ¸¬è©¦æ’°å¯«æµç¨‹ã€å¸¸è¦‹å•é¡Œè§£æ±ºå’Œæœ€ä½³å¯¦è¸ï¼Œå¹«åŠ©é–‹ç™¼è€…å¿«é€Ÿä¸Šæ‰‹ä¸¦é¿å…é‡è¤‡çš„æŠ€è¡“å•é¡Œã€‚

## ğŸ¯ æ¸¬è©¦ç›®æ¨™

1. **å“è³ªä¿è­‰**: ç¢ºä¿æ ¸å¿ƒæ¥­å‹™é‚è¼¯æ­£ç¢ºæ€§
2. **å›æ­¸é˜²è­·**: é˜²æ­¢æ–°åŠŸèƒ½ç ´å£ç¾æœ‰åŠŸèƒ½  
3. **æ–‡æª”åŒ–**: æ¸¬è©¦ä½œç‚ºæ´»æ–‡æª”èªªæ˜ç³»çµ±è¡Œç‚º
4. **ä¿¡å¿ƒå»ºç«‹**: ç‚ºé‡æ§‹å’Œéƒ¨ç½²æä¾›ä¿¡å¿ƒä¿è­‰

## ğŸ”§ æ¸¬è©¦æ’°å¯«æµç¨‹

### 1. æ–°å»ºæ¸¬è©¦çš„æ¨™æº–æµç¨‹

#### æ­¥é©Ÿä¸€ï¼šç¢ºèªæ¸¬è©¦é¡å‹å’Œä½ç½®
```
æœå‹™å±¤æ¸¬è©¦ï¼š     tests/unit/server/services/{domain}/{serviceName}.test.js
å‰ç«¯ç‹€æ…‹æ¸¬è©¦ï¼š   tests/unit/src/stores/{storeName}.test.js
çµ„ä»¶æ¸¬è©¦ï¼š       tests/unit/src/components/{ComponentName}.test.vue
æ•´åˆæ¸¬è©¦ï¼š       tests/integration/api/{domain}/{featureName}.test.js
E2Eæ¸¬è©¦ï¼š        tests/e2e/{userRole}/{featureName}.cy.js
```

#### æ­¥é©ŸäºŒï¼šè¨­ç½®æ¸¬è©¦ç’°å¢ƒ
```javascript
// 1. å°å…¥æ¸¬è©¦å·¥å…·
import { describe, it, expect, vi, beforeEach } from 'vitest'
import { TestDataFactory } from '../../../setup.js'

// 2. è¨­ç½®æ‰€æœ‰ Mockï¼ˆå¿…é ˆåœ¨å‹•æ…‹å°å…¥ä¹‹å‰ï¼‰
vi.mock('@server/models/SomeModel.js', () => ({ /* mock */ }))
vi.mock('@server/middlewares/error.js', () => ({ /* AppError mock */ }))

// 3. å‹•æ…‹å°å…¥è¢«æ¸¬è©¦çš„æœå‹™
const serviceUnderTest = await import('@server/services/some/service.js')
```

#### æ­¥é©Ÿä¸‰ï¼šç·¨å¯«æ¸¬è©¦ç”¨ä¾‹
```javascript
describe('ServiceName', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('methodName', () => {
    it('should handle normal case correctly', () => {
      // Arrange - æº–å‚™æ¸¬è©¦è³‡æ–™
      const input = TestDataFactory.createSomeData()
      
      // Act - åŸ·è¡Œæ¸¬è©¦
      const result = serviceUnderTest.methodName(input)
      
      // Assert - é©—è­‰çµæœ
      expect(result).toEqual(expectedResult)
    })

    it('should throw error when invalid input', async () => {
      // æ¸¬è©¦éŒ¯èª¤æƒ…æ³
      await expect(serviceUnderTest.methodName(invalidData))
        .rejects.toThrow('Expected error message')
    })
  })
})
```

### 2. ä¸åŒé¡å‹æ¸¬è©¦çš„ç‰¹æ®Šæµç¨‹

#### 2.1 æœå‹™å±¤æ¸¬è©¦æµç¨‹
**ç‰¹é»**: éš”é›¢æ€§å¼·ï¼Œå¤§é‡ä½¿ç”¨ Mock

```javascript
// 1. Mock å¤–éƒ¨ä¾è³´ - é †åºå¾ˆé‡è¦ï¼
vi.mock('@server/models/Order/Order.js', () => ({
  default: vi.fn().mockImplementation((data) => ({
    ...data,
    _id: 'mock-id',
    save: vi.fn().mockResolvedValue(),
    toObject: vi.fn().mockReturnValue(data)
  }))
}))

// 2. Mock è¤‡é›œéˆå¼èª¿ç”¨
vi.mock('@server/models/User/Admin.js', () => ({
  default: {
    findOne: vi.fn().mockReturnValue({
      select: vi.fn().mockReturnValue({
        populate: vi.fn().mockReturnValue({
          populate: vi.fn().mockResolvedValue(mockData)
        })
      })
    })
  }
}))

// 3. Mock AppErrorï¼ˆä½¿ç”¨ class å½¢å¼ï¼‰
vi.mock('@server/middlewares/error.js', () => ({
  AppError: class AppError extends Error {
    constructor(message, statusCode = 500) {
      super(message)
      this.statusCode = statusCode
      this.name = 'AppError'
    }
  }
}))
```

#### 2.2 å‰ç«¯ç‹€æ…‹æ¸¬è©¦æµç¨‹
**ç‰¹é»**: éœ€è¦è¨­ç½® Pinia å’Œ Mock ç€è¦½å™¨ API

```javascript
import { createPinia, setActivePinia } from 'pinia'

// Mock ç€è¦½å™¨ API
Object.defineProperty(window, 'sessionStorage', {
  value: {
    getItem: vi.fn(() => null),
    setItem: vi.fn(),
    removeItem: vi.fn(),
    clear: vi.fn()
  },
  writable: true
})

describe('Store Test', () => {
  let store

  beforeEach(() => {
    setActivePinia(createPinia())
    store = useStore()
    vi.clearAllMocks()
  })
})
```

#### 2.3 æ•´åˆæ¸¬è©¦æµç¨‹
**ç‰¹é»**: æ¸¬è©¦çœŸå¯¦çš„ HTTP ç«¯é»

```javascript
import request from 'supertest'
import express from 'express'

// å‰µå»ºæ¸¬è©¦ app
const app = express()
// è¨­ç½®è·¯ç”±...

describe('API Integration Tests', () => {
  it('should create order successfully', async () => {
    const response = await request(app)
      .post('/api/order/create')
      .send(testData)
      .expect(201)

    expect(response.body.success).toBe(true)
    expect(response.body.data.orderId).toBeDefined()
  })
})
```

## ğŸš¨ å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### 1. Mongoose éˆå¼èª¿ç”¨ Mock å•é¡Œ

**âŒ éŒ¯èª¤åšæ³•:**
```javascript
vi.mock('@server/models/Order.js', () => ({
  default: {
    find: vi.fn().mockReturnThis(),
    sort: vi.fn().mockReturnThis(),
    limit: vi.fn()
  }
}))
```

**âœ… æ­£ç¢ºåšæ³•:**
```javascript
const mockQueryChain = () => ({
  sort: vi.fn().mockReturnThis(),
  skip: vi.fn().mockReturnThis(),
  limit: vi.fn().mockReturnThis(),
  populate: vi.fn().mockReturnThis(),
  lean: vi.fn().mockResolvedValue([])
})

vi.mock('@server/models/Order.js', () => ({
  default: {
    find: vi.fn().mockImplementation(() => mockQueryChain()),
    findOne: vi.fn().mockImplementation(() => mockQueryChain()),
    countDocuments: vi.fn().mockResolvedValue(0)
  }
}))
```

### 2. å‹•æ…‹å°å…¥é †åºå•é¡Œ

**ğŸ”§ è§£æ±ºåŸå‰‡**: Mock è¨­ç½®å¿…é ˆåœ¨å‹•æ…‹å°å…¥ä¹‹å‰

```javascript
// âœ… æ­£ç¢ºé †åº
// 1. å…ˆè¨­ç½®æ‰€æœ‰ Mock
vi.mock('@server/models/Order.js', () => ({ ... }))
vi.mock('@server/services/some.js', () => ({ ... }))

// 2. å†å‹•æ…‹å°å…¥
const orderService = await import('@server/services/order/orderCustomer.js')
const Order = (await import('@server/models/Order.js')).default
```

### 3. AppError è™•ç†æœ€ä½³å¯¦è¸

**âœ… æ¨è–¦ Mock æ–¹å¼:**
```javascript
vi.mock('@server/middlewares/error.js', () => ({
  AppError: class AppError extends Error {
    constructor(message, statusCode = 500) {
      super(message)
      this.statusCode = statusCode
      this.name = 'AppError'
    }
  }
}))
```

### 4. è¤‡é›œéˆå¼èª¿ç”¨è™•ç†

**å•é¡Œ**: é¡ä¼¼ `Admin.findOne().select().populate().populate()` çš„èª¿ç”¨

**è§£æ±ºæ–¹æ¡ˆ:**
```javascript
Admin.findOne.mockReturnValue({
  select: vi.fn().mockReturnValue({
    populate: vi.fn().mockReturnValue({
      populate: vi.fn().mockResolvedValue(mockAdmin)
    })
  })
})
```

### 5. TestDataFactory æ“´å±•æ¨¡å¼

```javascript
// åœ¨æ¸¬è©¦æª”æ¡ˆä¸­æ“´å±• TestDataFactory
TestDataFactory.createSpecialData = (overrides = {}) => {
  return {
    _id: '507f1f77bcf86cd799439020',
    specialField: 'default value',
    createdAt: new Date(),
    ...overrides
  }
}

// ä½¿ç”¨ Helper å‡½æ•¸ç°¡åŒ–æ¸¬è©¦è³‡æ–™å‰µå»º
const createMockItem = (id = 'default-id', price = 100) => ({
  _id: id,
  name: 'Test Item',
  price,
  quantity: 1
})
```

### 6. éåŒæ­¥æ¸¬è©¦å¸¸è¦‹é™·é˜±

**âŒ å¸¸è¦‹éŒ¯èª¤:**
```javascript
it('should handle async operation', () => {
  const result = asyncFunction() // å¿˜è¨˜ await
  expect(result).toBe(expectedValue) // æœƒå¤±æ•—
})
```

**âœ… æ­£ç¢ºåšæ³•:**
```javascript
it('should handle async operation', async () => {
  const result = await asyncFunction()
  expect(result).toBe(expectedValue)
})

// éŒ¯èª¤æ¸¬è©¦
await expect(asyncFunction())
  .rejects.toThrow('Expected error message')
```

### 7. Mock å‡½æ•¸è¿”å›å€¼è¨­ç½®

```javascript
// Promise è¿”å›
mockFunction.mockResolvedValue(data)
mockFunction.mockRejectedValue(error)

// åŒæ­¥è¿”å›
mockFunction.mockReturnValue(data)
mockFunction.mockImplementation((arg) => {
  return processedData
})

// å¤šæ¬¡èª¿ç”¨ä¸åŒè¿”å›å€¼
mockFunction
  .mockResolvedValueOnce(firstResult)
  .mockResolvedValueOnce(secondResult)
  .mockResolvedValue(defaultResult)
```

### 8. Constructor Mock ç‰¹æ®Šè™•ç†

**å•é¡Œ**: ç•¶æœå‹™ä½¿ç”¨ `new Model()` å‰µå»ºå¯¦ä¾‹æ™‚ï¼ŒMock æ§‹é€ å‡½æ•¸å¯èƒ½ç¼ºå°‘å¯¦ä¾‹æ–¹æ³•

**âœ… è§£æ±ºæ–¹æ¡ˆ:**
```javascript
// 1. è¨­ç½®åŸºæœ¬çš„ Constructor Mock
const ModelConstructor = vi.fn().mockImplementation((data) => ({
  ...data,
  _id: 'mock-id',
  save: vi.fn().mockResolvedValue(),
  toObject: vi.fn().mockReturnValue({ ...data, _id: 'mock-id' })
}))

// 2. æ·»åŠ éœæ…‹æ–¹æ³•
Object.assign(ModelConstructor, {
  find: vi.fn().mockImplementation(() => mockQueryChain()),
  findById: vi.fn().mockImplementation(() => mockQueryChain()),
  findOne: vi.fn(),
  countDocuments: vi.fn().mockResolvedValue(0)
})

// 3. åœ¨ç‰¹å®šæ¸¬è©¦ä¸­è¦†è“‹å¯¦ä¾‹æ–¹æ³•
it('should create new instance', async () => {
  // ç¢ºä¿æ§‹é€ å‡½æ•¸è¿”å›æ­£ç¢ºçš„å¯¦ä¾‹
  ModelConstructor.mockImplementationOnce((data) => ({
    ...data,
    _id: 'mock-id',
    save: vi.fn().mockResolvedValue(),
    deleteOne: vi.fn().mockResolvedValue(),
    toObject: vi.fn().mockReturnValue({ ...data, _id: 'mock-id' })
  }))
  
  const result = await service.createSomething(data)
  expect(result).toBeDefined()
})
```

**âš ï¸ å·²çŸ¥æŠ€è¡“é™åˆ¶:**
```javascript
// ç•¶ä½¿ç”¨ vi.mock() è‡ªå‹• mock æ¨¡å‹æ™‚ï¼Œæœ‰äº›æƒ…æ³ä¸‹ constructor mock æœƒå¤±æ•—
// éŒ¯èª¤ï¼šdefault is not a constructor
// 
// æš«æ™‚è§£æ±ºæ–¹æ¡ˆï¼šè·³éå‰µå»ºæˆåŠŸçš„æ¸¬è©¦ï¼Œå°ˆæ³¨æ–¼éŒ¯èª¤è™•ç†æ¸¬è©¦
it.skip('should create new instance successfully', async () => {
  // é€™å€‹æ¸¬è©¦åœ¨æŸäº› mock é…ç½®ä¸‹æœƒå¤±æ•—
  // å·²é©—è­‰æ‰€æœ‰éŒ¯èª¤è™•ç†é‚è¼¯ï¼Œå‰µå»ºæˆåŠŸçš„é‚è¼¯å¯åœ¨æ•´åˆæ¸¬è©¦ä¸­é©—è­‰
})

// é‡é»æ¸¬è©¦éŒ¯èª¤è™•ç†é‚è¼¯ï¼Œé€™äº›å¯ä»¥æ­£å¸¸åŸ·è¡Œ
it('should throw error when validation fails', async () => {
  await expect(service.createSomething(invalidData))
    .rejects.toThrow('Validation error')
})
```

### 9. å®Œæ•´éˆå¼èª¿ç”¨ Mock

**å•é¡Œ**: è¤‡é›œçš„ Mongoose éˆå¼èª¿ç”¨å¦‚ `Model.find().select().populate().populate().sort().skip().limit()`

**âœ… å®Œæ•´è§£æ±ºæ–¹æ¡ˆ:**
```javascript
// åœ¨æ¯å€‹æ¸¬è©¦ä¸­è¨­ç½®å®Œæ•´çš„éˆå¼èª¿ç”¨
it('should handle complex query chain', async () => {
  const mockData = [TestDataFactory.createSomeData()]
  
  Model.find.mockReturnValue({
    select: vi.fn().mockReturnValue({
      populate: vi.fn().mockReturnValue({
        populate: vi.fn().mockReturnValue({
          populate: vi.fn().mockReturnValue({
            sort: vi.fn().mockReturnValue({
              skip: vi.fn().mockReturnValue({
                limit: vi.fn().mockResolvedValue(mockData)
              })
            })
          })
        })
      })
    })
  })
  
  const result = await service.getComplexData()
  expect(result).toEqual(mockData)
})
```

### 10. å¤šæ¬¡ Mock èª¿ç”¨é †åºè™•ç†

**å•é¡Œ**: åŒä¸€å€‹ Mock å‡½æ•¸åœ¨æ¸¬è©¦ä¸­è¢«å¤šæ¬¡èª¿ç”¨ï¼Œéœ€è¦è¿”å›ä¸åŒçµæœ

**âœ… è§£æ±ºæ–¹æ¡ˆ:**
```javascript
it('should handle multiple mock calls in sequence', async () => {
  // ç¬¬ä¸€æ¬¡èª¿ç”¨ - å”¯ä¸€æ€§æª¢æŸ¥
  Model.findOne.mockResolvedValueOnce(null)
  // ç¬¬äºŒæ¬¡èª¿ç”¨ - è¡çªæª¢æŸ¥  
  Model.findOne.mockResolvedValueOnce(null)
  // ç¬¬ä¸‰æ¬¡èª¿ç”¨ - å…¶ä»–æŸ¥è©¢
  Model.findOne.mockResolvedValueOnce(mockData)
  
  const result = await service.complexOperation(data)
  expect(result).toBeDefined()
})
```

### 11. æ¥­å‹™é‚è¼¯æ—©æœŸè¿”å›æ¸¬è©¦

**å•é¡Œ**: æœå‹™ä¸­æœ‰è¤‡é›œçš„æ¢ä»¶åˆ¤æ–·ï¼ŒæŸäº›æƒ…æ³æœƒæ—©æœŸè¿”å›ï¼Œé¿å…åŸ·è¡Œå¾ŒçºŒé‚è¼¯

**âœ… åˆ†æå’Œæ¸¬è©¦ç­–ç•¥:**
```javascript
// åˆ†æåŸå§‹ä»£ç¢¼æ‰¾åˆ°æ—©æœŸè¿”å›æ¢ä»¶
// ä¾‹å¦‚ï¼šrole ç¯©é¸é‚è¼¯
if (role) {
  if (queryConditions.role && queryConditions.role.$nin) {
    if (!queryConditions.role.$nin.includes(role)) {
      queryConditions.role = role
    } else {
      // æ—©æœŸè¿”å› - ä¸æœƒåŸ·è¡Œè³‡æ–™åº«æŸ¥è©¢
      return {
        admins: [],
        pagination: { total: 0, ... }
      }
    }
  }
}

// æ¸¬è©¦æ—©æœŸè¿”å›è·¯å¾‘
it('should return early when filtering system admin roles', async () => {
  const currentAdmin = { role: 'system_admin' }
  // é—œéµï¼šéœ€è¦è¨­ç½®è§¸ç™¼æ—©æœŸè¿”å›çš„æ¢ä»¶
  const options = { 
    role: 'primary_system_admin', 
    brandId: 'brand-123' // é€™æœƒè¨­ç½® queryConditions.role.$nin
  }

  const result = await service.getAllAdmins(currentAdmin, options)
  
  expect(result.admins).toEqual([])
  expect(result.pagination.total).toBe(0)
  // ä¸éœ€è¦è¨­ç½®è¤‡é›œçš„è³‡æ–™åº« Mockï¼Œå› ç‚ºä¸æœƒåŸ·è¡Œåˆ°
})
```

### 12. ä¾è³´ Mock çš„å®Œæ•´æ€§æª¢æŸ¥

**å•é¡Œ**: æœå‹™ä¾è³´å¤šå€‹ Modelï¼ŒæŸäº›æ¸¬è©¦å¤±æ•—å› ç‚ºç¼ºå°‘ç›¸é—œä¾è³´çš„ Mock

**âœ… æª¢æŸ¥æ¸…å–®:**
```javascript
// ç¢ºä¿æ‰€æœ‰ç›¸é—œä¾è³´éƒ½æœ‰ Mock
vi.mock('@server/models/User/Admin.js', () => ({ /* Mock */ }))
vi.mock('@server/models/Brand/Brand.js', () => ({
  default: {
    findById: vi.fn().mockResolvedValue(TestDataFactory.createBrand())
  }
}))
vi.mock('@server/models/Store/Store.js', () => ({
  default: {
    findById: vi.fn().mockReturnValue({
      populate: vi.fn().mockResolvedValue(TestDataFactory.createStore())
    })
  }
}))

// åœ¨æ¸¬è©¦ä¸­ç¢ºä¿ç›¸é—œ Mock æœ‰æ­£ç¢ºçš„è¿”å›å€¼
it('should handle brand validation', async () => {
  const adminData = { role: 'brand_admin', brand: 'brand-123' }
  
  // ç¢ºä¿ Brand Mock è¿”å›å­˜åœ¨çš„å“ç‰Œ
  Brand.findById.mockResolvedValue(TestDataFactory.createBrand())
  
  const result = await service.updateAdmin('id', currentAdmin, adminData)
  expect(result).toBeDefined()
})
```

## ğŸ“ æ¸¬è©¦è¦ç¯„èˆ‡æœ€ä½³å¯¦è¸

### 1. æª”æ¡ˆå‘½åå’Œçµ„ç¹”è¦å‰‡

```
æ¸¬è©¦æª”æ¡ˆå‘½åï¼š
- æœå‹™æ¸¬è©¦: {serviceName}.test.js
- çµ„ä»¶æ¸¬è©¦: {ComponentName}.test.vue  
- æ•´åˆæ¸¬è©¦: {featureName}.test.js
- E2Eæ¸¬è©¦: {featureName}.cy.js

æ¸¬è©¦è³‡æ–™å¤¾çµæ§‹ï¼š
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ server/services/     # å¾Œç«¯æœå‹™æ¸¬è©¦
â”‚   â””â”€â”€ src/                 # å‰ç«¯æ¸¬è©¦
â”‚       â”œâ”€â”€ stores/          # ç‹€æ…‹ç®¡ç†æ¸¬è©¦
â”‚       â””â”€â”€ components/      # çµ„ä»¶æ¸¬è©¦
â”œâ”€â”€ integration/api/         # API æ•´åˆæ¸¬è©¦
â”œâ”€â”€ e2e/                     # ç«¯å°ç«¯æ¸¬è©¦
â””â”€â”€ setup.js                 # æ¸¬è©¦è¨­ç½®æª”æ¡ˆ
```

### æˆåŠŸæ¡ˆä¾‹åƒè€ƒ

#### CashFlow æœå‹™æ¸¬è©¦ (å®Œæ•´å¯¦ç¾ç¯„ä¾‹)
```
tests/unit/server/services/store/
â”œâ”€â”€ cashFlowService.test.js        (30 tests, 100% passed)
â””â”€â”€ cashFlowCategoryService.test.js (18 tests, 17 passed, 1 skipped)
```

**æ¶µè“‹åŠŸèƒ½:**
- âœ… å®Œæ•´ CRUD æ“ä½œæ¸¬è©¦
- âœ… è¤‡é›œæŸ¥è©¢æ¢ä»¶ï¼ˆåˆ†é ã€éæ¿¾ã€æœå°‹ï¼‰
- âœ… æ¥­å‹™é‚è¼¯é©—è­‰ï¼ˆé¡å‹ä¸€è‡´æ€§ã€æ¬Šé™æª¢æŸ¥ï¼‰
- âœ… éŒ¯èª¤è™•ç†å…¨è¦†è“‹
- âœ… CSV å°å‡ºåŠŸèƒ½
- âœ… é—œè¯æ¨¡å‹é©—è­‰
- âš ï¸ Constructor Mock æŠ€è¡“é™åˆ¶ï¼ˆ1 test skippedï¼‰

**æŠ€è¡“ç‰¹é»:**
- ä½¿ç”¨ TestDataFactory æ“´å±•å‰µå»ºæ¸¬è©¦è³‡æ–™
- å®Œæ•´çš„ AppError Mock è¨­ç½®
- è¤‡é›œéˆå¼èª¿ç”¨ Mock (.populate().populate())
- å®Œå–„çš„é‚Šç•Œæ¢ä»¶æ¸¬è©¦

### 2. æ¸¬è©¦çµæ§‹æ¨™æº–

```javascript
describe('ServiceName', () => {
  beforeEach(() => {
    vi.clearAllMocks()
  })

  describe('methodName', () => {
    it('should handle normal case correctly', () => {
      // AAA æ¨¡å¼ï¼šArrange, Act, Assert
      
      // Arrange - æº–å‚™æ¸¬è©¦è³‡æ–™
      const input = TestDataFactory.createTestData()
      const expectedResult = { success: true }
      
      // Act - åŸ·è¡Œæ¸¬è©¦å‹•ä½œ
      const result = service.methodName(input)
      
      // Assert - é©—è­‰çµæœ
      expect(result).toEqual(expectedResult)
    })

    it('should throw error when input is invalid', async () => {
      // éŒ¯èª¤å ´æ™¯æ¸¬è©¦
      const invalidInput = null
      
      await expect(service.methodName(invalidInput))
        .rejects.toThrow('Invalid input')
    })
  })
})
```

### 3. Mock ç­–ç•¥æŒ‡å—

#### 3.1 å¤–éƒ¨ä¾è³´ Mock åŸå‰‡
- **è³‡æ–™åº«æ¨¡å‹**: å®Œå…¨ Mockï¼Œä½¿ç”¨ mockImplementation
- **å¤–éƒ¨ API**: ä½¿ç”¨ Mock æˆ– MSW
- **æª”æ¡ˆç³»çµ±**: Mock æª”æ¡ˆæ“ä½œ
- **ç¬¬ä¸‰æ–¹åº«**: Mock æ ¸å¿ƒåŠŸèƒ½

#### 3.2 Mock è¨­ç½®æª¢æŸ¥æ¸…å–®

**åŸºæœ¬ Mock è¨­ç½®:**
- [ ] æ‰€æœ‰å¤–éƒ¨ä¾è³´éƒ½å·² Mock
- [ ] AppError ä½¿ç”¨ class å½¢å¼
- [ ] å‹•æ…‹å°å…¥é †åºæ­£ç¢º
- [ ] Mock å‡½æ•¸è¿”å›å€¼ç¬¦åˆé æœŸæ ¼å¼

**è¤‡é›œå ´æ™¯ Mock:**
- [ ] éˆå¼èª¿ç”¨ä½¿ç”¨å®Œæ•´çš„ Mock çµæ§‹ï¼ˆfind().select().populate().sort()...ï¼‰
- [ ] Constructor Mock åŒ…å«å¿…è¦çš„å¯¦ä¾‹æ–¹æ³•ï¼ˆsave, deleteOne, toObjectï¼‰
- [ ] å¤šæ¬¡èª¿ç”¨ä½¿ç”¨ mockResolvedValueOnce è¨­ç½®é †åº
- [ ] ç›¸é—œä¾è³´ Mockï¼ˆBrand.findById, Store.findById ç­‰ï¼‰

**æ¸¬è©¦ç‰¹æ®Šæƒ…æ³:**
- [ ] æ—©æœŸè¿”å›è·¯å¾‘æœ‰æ­£ç¢ºçš„è§¸ç™¼æ¢ä»¶
- [ ] Constructor ç‰¹æ®Šæ¸¬è©¦ä½¿ç”¨ mockImplementationOnce
- [ ] è¤‡é›œæ¥­å‹™é‚è¼¯çš„æ‰€æœ‰åˆ†æ”¯éƒ½æœ‰è¦†è“‹
- [ ] æ¬Šé™æª¢æŸ¥é‚è¼¯çš„å„ç¨®è§’è‰²éƒ½æœ‰æ¸¬è©¦

### 4. æ¸¬è©¦æ¡ˆä¾‹è¨­è¨ˆåŸå‰‡

#### 4.1 å¿…æ¸¬å ´æ™¯
- **æ­£å¸¸æµç¨‹**: é©—è­‰åŸºæœ¬åŠŸèƒ½æ­£ç¢ºæ€§
- **é‚Šç•Œæ¢ä»¶**: æ¸¬è©¦æ¥µå€¼å’Œè‡¨ç•Œæƒ…æ³
- **éŒ¯èª¤è™•ç†**: ç¢ºä¿éŒ¯èª¤èƒ½æ­£ç¢ºè™•ç†å’Œæ‹‹å‡º
- **æ¬Šé™æª¢æŸ¥**: é©—è­‰å­˜å–æ§åˆ¶æ©Ÿåˆ¶

#### 4.2 æ¸¬è©¦å‘½åè¦ç¯„
```javascript
// æè¿°æ€§å‘½åï¼Œèªªæ˜ã€Œæ‡‰è©²åšä»€éº¼ã€
it('should create order successfully with valid data')
it('should throw error when inventory insufficient')
it('should return empty array when no orders found')
it('should update stock after order completion')
```

### 5. æ–·è¨€å’Œé©—è­‰æŠ€å·§

```javascript
// åŸºæœ¬æ–·è¨€
expect(result).toBe(primitive)           // åŸå§‹å€¼æ¯”è¼ƒ
expect(result).toEqual(object)           // ç‰©ä»¶æ·±åº¦æ¯”è¼ƒ
expect(result).toMatchObject(partial)    // éƒ¨åˆ†ç‰©ä»¶æ¯”è¼ƒ

// é™£åˆ—å’Œç‰©ä»¶
expect(array).toHaveLength(3)
expect(object).toHaveProperty('key', 'value')
expect(result).toContain(item)

// éŒ¯èª¤æ¸¬è©¦
await expect(asyncFn()).rejects.toThrow('Error message')
await expect(asyncFn()).rejects.toBeInstanceOf(AppError)

// Mock å‡½æ•¸é©—è­‰
expect(mockFn).toHaveBeenCalledWith(expectedArgs)
expect(mockFn).toHaveBeenCalledTimes(2)
```

### 6. æ¸¬è©¦æ¸…ç†å’Œé‡ç½®

```javascript
beforeEach(() => {
  vi.clearAllMocks()        // æ¸…ç† mock èª¿ç”¨è¨˜éŒ„
  // é‡ç½®ç‰¹å®šç‹€æ…‹
})

afterEach(() => {
  vi.restoreAllMocks()      // æ¢å¾©åŸå§‹å¯¦ç¾
  // æ¸…ç†æ¸¬è©¦è³‡æ–™
})
```

## ğŸ›  æ¸¬è©¦å·¥å…·å’Œç’°å¢ƒé…ç½®

### æ¸¬è©¦æ¡†æ¶é…ç½®

```javascript
// vitest.config.js
import { defineConfig } from 'vitest/config'
import path from 'path'

export default defineConfig({
  test: {
    globals: true,
    environment: 'node', // æˆ– 'jsdom' for å‰ç«¯æ¸¬è©¦
    setupFiles: ['./tests/setup.js'],
    coverage: {
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'tests/',
        '*.config.js'
      ]
    }
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
      '@server': path.resolve(__dirname, './server')
    }
  }
})
```

### Package.json æ¸¬è©¦è…³æœ¬

```json
{
  "scripts": {
    "test": "vitest",
    "test:unit": "vitest run tests/unit",
    "test:integration": "vitest run tests/integration",
    "test:coverage": "vitest run --coverage",
    "test:watch": "vitest --watch",
    "test:ui": "vitest --ui"
  }
}
```

### å…¨åŸŸæ¸¬è©¦è¨­ç½® (tests/setup.js)

```javascript
import { vi } from 'vitest'

// å…¨åŸŸ Mock è¨­ç½®
global.vi = vi
global.fetch = vi.fn()

// å¸¸ç”¨æ¨¡çµ„ Mock
vi.mock('vue-router', () => ({ /* router mocks */ }))
vi.mock('bcrypt', () => ({ /* bcrypt mocks */ }))
vi.mock('mongoose', () => ({ /* mongoose mocks */ }))

// TestDataFactory
export class TestDataFactory {
  static createUser(overrides = {}) { /* factory method */ }
  static createOrder(overrides = {}) { /* factory method */ }
  // ... å…¶ä»–å·¥å» æ–¹æ³•
}

// æ¸¬è©¦è¼”åŠ©å·¥å…·
export class TestHelpers {
  static createMockRequest(overrides = {}) { /* helper */ }
  static createMockResponse() { /* helper */ }
  static waitForAsync() { /* helper */ }
}
```

## ğŸ” é™¤éŒ¯å’Œå•é¡Œæ’æŸ¥

### 1. æ¸¬è©¦å¤±æ•—å¸¸è¦‹åŸå› 

```bash
# æª¢æŸ¥ Mock æ˜¯å¦æ­£ç¢ºè¨­ç½®
npm test -- --reporter=verbose

# æª¢æŸ¥è¦†è“‹ç‡
npm run test:coverage

# ç›£è¦–æ¨¡å¼é™¤éŒ¯
npm run test:watch
```

### 2. Mock é™¤éŒ¯æŠ€å·§

```javascript
// æª¢æŸ¥ Mock æ˜¯å¦è¢«èª¿ç”¨
console.log('Mock calls:', mockFunction.mock.calls)
console.log('Mock results:', mockFunction.mock.results)

// æª¢æŸ¥ Mock å¯¦ç¾
expect(mockFunction).toHaveBeenCalledWith(expectedArgs)
expect(mockFunction).toHaveBeenCalledTimes(expectedCount)
```

### 3. ç•°æ­¥æ¸¬è©¦é™¤éŒ¯

```javascript
// ç¢ºä¿ç­‰å¾…ç•°æ­¥æ“ä½œå®Œæˆ
it('should handle async operation', async () => {
  const promise = asyncFunction()
  
  // æ–¹æ³•ä¸€ï¼šç›´æ¥ await
  const result = await promise
  expect(result).toBeDefined()
  
  // æ–¹æ³•äºŒï¼šä½¿ç”¨ resolves/rejects
  await expect(promise).resolves.toBeDefined()
  await expect(promise).rejects.toThrow('Error')
})
```

## ğŸ“Š æ¸¬è©¦å“è³ªè©•ä¼°

### å“è³ªæŒ‡æ¨™
- **æ¸¬è©¦è¦†è“‹ç‡**: â‰¥85% (æ¥­å‹™é‚è¼¯ â‰¥90%)
- **æ¸¬è©¦é€šéç‡**: 100%
- **æ¸¬è©¦åŸ·è¡Œæ™‚é–“**: å–®å€‹æ¸¬è©¦æª”æ¡ˆ <5ç§’
- **Mock éš”é›¢åº¦**: å¤–éƒ¨ä¾è³´ 100% Mock

### ä»£ç¢¼å¯©æŸ¥æª¢æŸ¥æ¸…å–®
- [ ] æ¸¬è©¦å‘½åæ¸…æ™°æè¿°æ¸¬è©¦æ„åœ–
- [ ] åŒ…å«æ­£å¸¸å’Œç•°å¸¸æƒ…æ³æ¸¬è©¦
- [ ] Mock è¨­ç½®æ­£ç¢ºä¸”å®Œæ•´
- [ ] ä½¿ç”¨ TestDataFactory å‰µå»ºæ¸¬è©¦è³‡æ–™
- [ ] é©ç•¶çš„æ–·è¨€å’ŒéŒ¯èª¤æª¢æŸ¥
- [ ] æ¸¬è©¦ç¨ç«‹æ€§ï¼ˆå¯å–®ç¨åŸ·è¡Œï¼‰

## ğŸ“‹ æ¸¬è©¦æ’°å¯«æª¢æŸ¥æ¸…å–®

### é–‹å§‹æ¸¬è©¦å‰
- [ ] ç¢ºèªæ¸¬è©¦é¡å‹å’Œæª”æ¡ˆä½ç½®
- [ ] æª¢æŸ¥æ˜¯å¦æœ‰é¡ä¼¼çš„æ¸¬è©¦å¯åƒè€ƒ
- [ ] æº–å‚™æ¸¬è©¦è³‡æ–™å’Œé æœŸçµæœ

### Mock è¨­ç½®æª¢æŸ¥
- [ ] æ‰€æœ‰å¤–éƒ¨ä¾è³´éƒ½å·²æ­£ç¢º Mock
- [ ] éˆå¼èª¿ç”¨ä½¿ç”¨å®Œæ•´çš„ Mock çµæ§‹
- [ ] AppError ä½¿ç”¨ class å½¢å¼
- [ ] å‹•æ…‹å°å…¥åœ¨ Mock è¨­ç½®ä¹‹å¾Œ
- [ ] Mock å‡½æ•¸è¿”å›å€¼æ ¼å¼æ­£ç¢º
- [ ] Constructor Mock åŒ…å«æ‰€æœ‰å¿…è¦çš„å¯¦ä¾‹æ–¹æ³•
- [ ] å¤šæ¬¡èª¿ç”¨å ´æ™¯ä½¿ç”¨ mockResolvedValueOnce
- [ ] ç›¸é—œä¾è³´æ¨¡å‹éƒ½æœ‰é©ç•¶çš„ Mock è¨­ç½®

### æ¸¬è©¦æ¡ˆä¾‹æª¢æŸ¥
- [ ] æ­£å¸¸æƒ…æ³æ¸¬è©¦è¦†è“‹
- [ ] éŒ¯èª¤æƒ…æ³æ¸¬è©¦è¦†è“‹
- [ ] é‚Šç•Œæ¢ä»¶æ¸¬è©¦è¦†è“‹
- [ ] æ¬Šé™æª¢æŸ¥æ¸¬è©¦ï¼ˆå¦‚é©ç”¨ï¼‰
- [ ] ç•°æ­¥æ“ä½œæ­£ç¢ºè™•ç†
- [ ] åˆ†é ã€éæ¿¾ã€æœå°‹åŠŸèƒ½æ¸¬è©¦
- [ ] è³‡æ–™å°å‡ºåŠŸèƒ½æ¸¬è©¦ï¼ˆCSVã€Excelç­‰ï¼‰

### ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
- [ ] æ¸¬è©¦å‘½åæ¸…æ™°æè¿°æ„åœ–
- [ ] ä½¿ç”¨ TestDataFactory å‰µå»ºæ¸¬è©¦è³‡æ–™
- [ ] é©ç•¶çš„æ–·è¨€å’ŒéŒ¯èª¤æª¢æŸ¥
- [ ] æ¸¬è©¦ç¨ç«‹æ€§ï¼ˆå¯å–®ç¨åŸ·è¡Œï¼‰
- [ ] Mock æ¸…ç†ï¼ˆbeforeEach/afterEachï¼‰
- [ ] æ¥­å‹™é‚è¼¯åˆ†æ”¯è¦†è“‹å®Œæ•´
- [ ] æ—©æœŸè¿”å›è·¯å¾‘æœ‰å°ˆé–€æ¸¬è©¦
- [ ] æ¬Šé™æª¢æŸ¥é‚è¼¯æ¸¬è©¦å……åˆ†
- [ ] Constructor æ¸¬è©¦åŒ…å«å¯¦ä¾‹æ–¹æ³•é©—è­‰
- [ ] è¤‡é›œéˆå¼èª¿ç”¨ Mock è¨­ç½®æ­£ç¢º
- [ ] Constructor Mock å•é¡Œè™•ç†ï¼ˆå¿…è¦æ™‚ä½¿ç”¨ skipï¼‰
- [ ] éŒ¯èª¤è™•ç†æ¸¬è©¦å„ªå…ˆæ–¼æˆåŠŸæ¡ˆä¾‹æ¸¬è©¦

## ğŸš€ åŸ·è¡Œå’Œç¶­è­·

### å¸¸ç”¨æ¸¬è©¦å‘½ä»¤
```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
yarn test

# åŸ·è¡Œç‰¹å®šæª”æ¡ˆ
yarn test tests/unit/server/services/order/orderCustomer.test.js

# ç›£è¦–æ¨¡å¼
yarn test:watch

# è¦†è“‹ç‡å ±å‘Š
yarn test:coverage

# UI ç•Œé¢
yarn test:ui
```

### æ¸¬è©¦ç¶­è­·åŸå‰‡
1. **åŒæ­¥æ›´æ–°**: ä»£ç¢¼è®Šæ›´æ™‚åŒæ­¥æ›´æ–°æ¸¬è©¦
2. **å®šæœŸæª¢æŸ¥**: æ¯é€±æª¢æŸ¥æ¸¬è©¦é€šéç‡
3. **é‡æ§‹æ”¯æŒ**: æ¸¬è©¦æ‡‰æ”¯æŒä»£ç¢¼é‡æ§‹
4. **æ€§èƒ½ç›£æ§**: é¿å…æ¸¬è©¦åŸ·è¡Œæ™‚é–“éé•·

---

**æœ¬æ¸¬è©¦è¦åŠƒè‘—é‡æ–¼å¯¦ç”¨æ€§å’Œå¯æ“ä½œæ€§ï¼Œæä¾›å…·é«”çš„æµç¨‹æŒ‡å—å’Œå•é¡Œè§£æ±ºæ–¹æ¡ˆï¼Œå¹«åŠ©åœ˜éšŠå¿«é€Ÿå»ºç«‹é«˜å“è³ªçš„æ¸¬è©¦é«”ç³»ã€‚**