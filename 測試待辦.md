# 測試待辦清單

## 專案測試架構規劃

### 測試類型分類

- **Unit Tests**: 單元測試（services, utils, models）
- **Component Tests**: 組件測試（Vue components）
- **Integration Tests**: 整合測試（API endpoints）
- **E2E Tests**: 端到端測試（完整用戶流程）

---

## 一、後端測試 (Backend Tests)

### 1. 服務層測試 (Services)

`tests/unit/server/services/`

#### 1.1 庫存管理服務 ✅

- **檔案**: `inventory/stockManagement.test.js` ✅
- **測試內容**:
  - 獲取店鋪庫存清單
  - 獲取單個庫存項目
  - 根據菜品模板獲取庫存
  - 庫存篩選功能（類型、可用性）
  - 錯誤處理（找不到項目）

#### 1.2 庫存統計服務 ✅

- **檔案**: `inventory/stockStats.test.js` ✅
- **測試內容**:
  - 庫存統計數據計算
  - 低庫存警告統計
  - 庫存變動趨勢分析
  - 庫存報表生成
- **測試狀態**: 19個測試 (12個通過，7個Mock技術問題)

#### 1.3 訂單服務（客戶端）✅

- **檔案**: `order/orderCustomer.test.js` ✅
- **測試內容**:
  - 訂單金額計算
  - 訂單編號生成
  - 用戶訂單查詢
  - 支付處理
  - 支付回調處理
  - 兌換券發放

#### 1.4 訂單服務（管理端）✅

- **檔案**: `order/orderAdmin.test.js` ✅
- **測試內容**:
  - 訂單查詢與篩選 (getStoreOrders, getUserOrders)
  - 訂單狀態更新 (updateOrder)
  - 取消訂單處理 (cancelOrder)
  - 訂單詳情查詢 (getOrderById)
  - Bundle券生成和點數給予
  - Voucher/Coupon恢復機制

#### 1.5 用戶認證服務 ✅

- **檔案**: `user/userAuthService.test.js` ✅
- **測試內容**:
  - 用戶資料驗證
  - 姓名格式驗證
  - 電話號碼格式驗證
  - Email格式驗證
  - 邊界條件測試
  - 多欄位驗證錯誤處理

#### 1.6 管理員認證服務 ✅

- **檔案**: `user/adminAuthService.test.js` ✅
- **測試內容**:
  - 管理員登入（系統管理員 vs 品牌管理員）
  - 權限驗證（品牌權限、系統權限）
  - 會話管理（登入狀態檢查、登出）
  - 角色權限檢查
  - 密碼修改功能
  - 管理員資料更新
  - 各種錯誤情況處理（37個測試案例）

#### 1.7 菜品服務 ✅

- **檔案**: `dish/dishTemplate.test.js` ✅
- **測試內容**:
  - 菜品模板CRUD操作（getAllTemplates, getTemplateById, createTemplate, updateTemplate, deleteTemplate）
  - 菜品選項管理（getTemplateOptions）
  - 菜品分類管理
  - 菜品圖片處理（上傳、更新、刪除）
  - 選項類別驗證與權限檢查
  - 錯誤處理測試（32個測試案例，100% 通過）

#### 1.8 促銷服務 ✅

- **檔案**: `promotion/couponService.test.js` ✅
- **測試內容**:

  - 優惠券模板CRUD操作
  - 優惠券統計計算
  - 優惠券發放邏輯
  - 優惠券使用驗證
  - 權限檢查與錯誤處理
  - 分頁查詢功能（29個測試案例）

- **檔案**: `promotion/pointService.test.js` ✅
- **測試內容**:

  - 積分規則計算
  - 積分累積與扣除
  - 積分兌換功能
  - 積分歷史記錄（22個測試案例）

- **檔案**: `promotion/voucherService.test.js` ✅
- **測試內容**:

  - 兌換券模板CRUD操作
  - 兌換券統計計算
  - 用戶兌換券查詢
  - 兌換券使用驗證
  - 自動創建兌換券模板
  - 權限檢查與錯誤處理（29個測試案例）

#### 1.9 積分規則服務 ✅

- **檔案**: `promotion/pointRuleService.test.js` ✅
- **測試內容**:
  - 點數規則CRUD操作（getAllPointRules, getPointRuleById, createPointRule, updatePointRule, deletePointRule）
  - 啟用點數規則查詢（getActivePointRules）
  - 訂單點數計算邏輯（calculateOrderPoints）
  - 規則驗證與業務邏輯檢查
  - 權限檢查與錯誤處理（25個測試案例，100% 通過）

#### 1.9 店鋪管理服務

- **檔案**: `store/storeManagement.test.js`
- **測試內容**:
  - 店鋪資訊管理
  - 營業時間設定
  - 店鋪狀態管理
  - 配送設定

#### 1.10 菜單服務 ✅

- **檔案**: `store/menuService.test.js` ✅
- **測試內容**:
  - 獲取店鋪所有菜單（包含選項篩選）
  - 根據ID獲取特定菜單
  - 菜單建立與啟用狀態檢查
  - 菜單更新與狀態變更邏輯
  - 菜單刪除功能
  - 錯誤處理（店鋪不存在、菜單不存在）
- **測試狀態**: 18個測試 (100% 通過)

#### 1.11 套餐服務

- **檔案**: `bundle/bundleService.test.js`
- **測試內容**:

  - Bundle 模板CRUD操作
  - Bundle 項目管理
  - Bundle 價格計算
  - Bundle 可用性驗證

- **檔案**: `bundle/bundleInstance.test.js`
- **測試內容**:
  - Bundle 實例創建
  - Bundle 實例使用
  - Bundle 實例狀態管理
  - Bundle 實例與用戶關聯

#### 1.12 外送平台服務 ✅

- **檔案**: `delivery/ubereatsService.test.js` ✅
- **測試內容**:
  - UberEats API 串接
  - 菜單同步功能
  - 訂單同步處理
  - 錯誤處理與重試
- **測試狀態**: 27個測試 (21個通過，6個因sandbox模式fallback機制問題)

- **檔案**: `delivery/tokenManager.test.js`
- **測試內容**:

  - Token 管理邏輯
  - Token 刷新機制
  - 多店家 Token 管理
  - Token 安全驗證

- **檔案**: `delivery/orderSyncService.test.js`
- **測試內容**:
  - 訂單狀態同步
  - 外送平台訂單處理
  - 同步錯誤處理
  - 數據一致性驗證

#### 1.13 用戶相關服務

- **檔案**: `user/userProfile.test.js`
- **測試內容**:

  - 用戶資料管理
  - 資料驗證邏輯
  - 個人資訊更新
  - 隱私資料保護

- **檔案**: `user/adminService.test.js`
- **測試內容**:
  - 管理員資料管理
  - 權限分配邏輯
  - 管理員操作記錄
  - 角色權限驗證

#### 1.14 工具與輔助服務

- **檔案**: `image/r2Service.test.js`
- **測試內容**:

  - 圖片上傳處理
  - 雲端存儲整合
  - 圖片格式驗證
  - 錯誤處理機制

- **檔案**: `imageHelper.test.js`
- **測試內容**:
  - 圖片處理工具
  - 格式轉換功能
  - 圖片壓縮邏輯
  - 批量處理功能

#### 1.15 菜品相關服務 ✅

- **檔案**: `dish/dishInstance.test.js` ✅
- **測試內容**:
  - 獲取所有餐點實例（帶分頁功能）
  - 根據ID獲取餐點實例
  - 創建餐點實例（含選項驗證和價格計算）
  - 更新餐點實例（選項和特殊要求）
  - 刪除餐點實例
  - 餐點最終價格計算邏輯
  - 錯誤處理（模板不存在、選項不存在等）
- **測試狀態**: 23個測試 (100% 通過)

- **檔案**: `dish/optionCategoryService.test.js`
- **測試內容**:

  - 選項分類管理
  - 選項分類驗證
  - 分類排序邏輯
  - 選項約束規則

- **檔案**: `dish/optionService.test.js`
- **測試內容**:
  - 菜品選項管理
  - 選項價格計算
  - 選項可用性檢查
  - 選項組合驗證

### 2. 控制器測試 (Controllers)

`tests/unit/server/controllers/`

#### 2.1 訂單控制器 ✅

- **檔案**: `Order/orderCustomer.test.js` ✅
- **測試內容**:
  - API 請求處理（createOrder, getUserOrders, getUserOrderById, processPayment, paymentCallback）
  - 參數驗證（路由參數、查詢參數、請求體）
  - 響應格式（成功響應、錯誤響應）
  - 錯誤處理（404 訂單不存在）
  - 認證處理（已登入用戶 vs 匿名用戶）
  - 分頁參數處理（默認值、無效值）
- **測試狀態**: 14個測試 (100% 通過)

#### 2.2 用戶控制器 ✅

- **檔案**: `User/userAuth.test.js` ✅
- **測試內容**:
  - 用戶註冊 API（包含手機驗證碼驗證）
  - 用戶登入/登出 API
  - 手機驗證碼發送與驗證
  - 忘記密碼與重設密碼流程
  - 修改密碼功能
  - 用戶登入狀態檢查
  - 參數驗證（路由參數、請求體）
  - 響應格式驗證
  - 錯誤處理機制
  - 會話管理（login/logout）
- **測試狀態**: 19個測試 (100% 通過)

#### 2.3 庫存控制器 ✅

- **檔案**: `Store/inventory.test.js` ✅
- **測試內容**:
  - 獲取店鋪庫存列表（包含查詢過濾）
  - 獲取單個庫存項目
  - 創建庫存項目
  - 更新庫存項目
  - 設定可用庫存
  - 減少庫存（訂單消耗）
  - 增加庫存
  - 損耗處理
  - 初始化餐點庫存
  - 切換售完狀態
  - 獲取庫存變更日誌
  - 獲取項目庫存統計
  - 獲取庫存健康狀況報告
  - 批量更新庫存
  - 獲取庫存變更摘要
  - 參數驗證與錯誤處理
- **測試狀態**: 30個測試 (100% 通過)

#### 2.4 訂單管理控制器 ✅

- **檔案**: `Order/orderAdmin.test.js` ✅
- **測試內容**:
  - 獲取店鋪訂單列表（getStoreOrders）- 包含篩選條件和分頁參數
  - 獲取特定用戶訂單列表（getUserOrders）- 管理員功能，支援排序
  - 獲取訂單詳情（getOrderById）- 後台詳情查詢
  - 更新訂單（updateOrder）- 統一接口，支援混合購買獎勵
  - 取消訂單（cancelOrder）- 包含原因驗證和錯誤處理
  - 參數驗證（查詢參數、路由參數、請求體）
  - 響應格式驗證（成功響應、錯誤響應）
  - 錯誤處理（缺少必填參數）
  - 認證處理（管理員ID驗證）
  - 分頁參數處理（默認值、無效值）
- **測試狀態**: 11個測試 (100% 通過)

### 3. 中介軟體測試 (Middlewares)

`tests/unit/server/middlewares/`

#### 3.1 認證中介軟體

- **檔案**: `auth/authentication.test.js`
- **測試內容**:
  - JWT token 驗證
  - 會話檢查
  - 用戶狀態驗證
  - 錯誤處理

#### 3.2 授權中介軟體

- **檔案**: `auth/authorization.test.js`
- **測試內容**:
  - 角色權限檢查
  - 店鋪權限驗證
  - 功能權限檢查
  - 拒絕存取處理

#### 3.3 驗證中介軟體

- **檔案**: `validator.test.js`
- **測試內容**:
  - 輸入參數驗證
  - 資料格式檢查
  - 必填欄位驗證
  - 自定義驗證規則

### 4. 模型測試 (Models)

`tests/unit/server/models/`

#### 4.1 用戶模型

- **檔案**: `User/User.test.js`
- **測試內容**:
  - 資料驗證規則
  - 密碼加密
  - 虛擬屬性
  - 模型方法

#### 4.2 訂單模型

- **檔案**: `Order/Order.test.js`
- **測試內容**:
  - 訂單編號生成
  - 金額計算
  - 狀態轉換規則
  - 關聯資料

#### 4.3 庫存模型

- **檔案**: `Store/Inventory.test.js`
- **測試內容**:
  - 庫存數量驗證
  - 閾值檢查
  - 自動更新邏輯
  - 索引設定

### 5. 工具函數測試 (Utils)

`tests/unit/server/utils/`

#### 5.1 日期工具

- **檔案**: `date.test.js`
- **測試內容**:
  - 日期格式化
  - 時區轉換
  - 日期計算
  - 有效性檢查

---

## 二、前端測試 (Frontend Tests)

### 1. 狀態管理測試 (Stores)

`tests/unit/src/stores/`

#### 1.1 購物車狀態 ✅

- **檔案**: `cart.test.js` ✅
- **測試內容**:
  - 初始狀態管理
  - 品牌和店鋪管理
  - 訂單類型管理
  - 客戶資訊管理
  - 商品項目管理（菜品/套餐）
  - 優惠券管理
  - 支付方式設定
  - 總金額計算邏輯
  - 訂單驗證
  - 購物車清理

#### 1.2 客戶認證狀態 ✅

- **檔案**: `customerAuth.test.js` ✅
- **測試內容**:
  - 登入/登出狀態
  - 用戶資訊儲存
  - 品牌ID管理與sessionStorage同步
  - 註冊功能（包含驗證）
  - 登入功能（多種資料結構支援）
  - 登出功能（含錯誤處理）
  - 檢查登入狀態（含自動恢復）
  - 重設密碼功能
  - 修改密碼功能
  - 獲取用戶資料
  - 初始化與自動檢查
  - 計算屬性（userName, userId, currentBrandId）
  - 錯誤處理機制
- **測試狀態**: 44個測試 (100% 通過)

#### 1.3 菜單狀態 ✅

- **檔案**: `menu.test.js` ✅
- **測試內容**:
  - 初始狀態管理（currentMenuType, brandId, storeId）
  - 菜單類型設定（setMenuType）
  - 品牌店鋪設定（setBrandAndStore）
  - 計算屬性（menuTypeText, requiresAuth）
  - sessionStorage持久化（persistState, restoreState）
  - 狀態清除（clearState）
  - 錯誤處理機制
  - 複合操作與數據一致性驗證
- **測試狀態**: 23個測試 (100% 通過)

#### 1.4 櫃台系統狀態 ✅

- **檔案**: `counter/cart.test.js` ✅
- **測試內容**:
  - POS 購物車管理（初始狀態、添加菜品/套餐）
  - 購物車項目管理（移除、數量更新、編輯）
  - 價格調整（手動調帳、折扣）
  - 計算屬性（小計、總計）
  - 購物車清理和取消訂單
  - 項目合併邏輯
  - 結帳功能（訂單提交、錯誤處理）
- **測試狀態**: 40個測試 (100% 通過)

- **檔案**: `counter/inventory.test.js` ✅
- **測試內容**:
  - 初始狀態管理（inventoryData, isLoadingInventory）
  - 庫存資訊獲取（getInventoryInfo）
  - 菜品售完狀態檢查（isDishSoldOut）- 包含手動設定和庫存檢查邏輯
  - 庫存徽章樣式（getStockBadgeClass）- 不同庫存狀況顯示不同顏色
  - 庫存資料載入（loadInventoryData）- API 整合與錯誤處理
  - 庫存資料清理（clearInventoryData）
  - 邊界條件和異常處理（負數、浮點數、無效資料）
- **測試狀態**: 30個測試 (100% 通過)

- **檔案**: `counter/dishTemplates.test.js` ✅
- **測試內容**:
  - POS 菜品模板管理（fetchDishTemplates, fetchOptionCategoriesWithOptions）
  - 菜單資料載入與排序邏輯（fetchMenuData）
  - 餐點模板查詢功能（getDishTemplate）
  - 預設選項生成邏輯（getDefaultOptionsForDish）
  - API 錯誤處理與邊界條件測試
- **測試狀態**: 22個測試 (100% 通過)

- **檔案**: `counter/orders.test.js` ✅
- **測試內容**:
  - 初始狀態管理（todayOrders, selectedOrder, currentDate）
  - 訂單計算方法（小計、折扣、總計）
  - API 操作（載入當日訂單、按日期查詢訂單）
  - 訂單操作（選擇訂單、清空狀態）
  - 格式化方法重新導出驗證
  - 錯誤處理與日誌記錄
- **測試狀態**: 22個測試 (100% 通過)

- **檔案**: `counter/modals.test.js` ✅
- **測試內容**:
  - POS 彈窗狀態管理（初始狀態、模態框開啟關閉）
  - 調帳彈窗邏輯（新增調帳、編輯訂單調帳、計算功能）
  - 結帳彈窗邏輯（開啟結帳、狀態重置）
  - 現金計算器和桌號彈窗處理
  - 通用彈窗關閉和狀態管理完整性
- **測試狀態**: 27個測試 (100% 通過)

### 2. API 模組測試 (API Modules)

`tests/unit/src/api/modules/`

#### 2.1 訂單 API

- **檔案**: `orderCustomer.test.js`
- **測試內容**:
  - API 請求格式
  - 響應處理
  - 錯誤處理
  - 重試機制

#### 2.2 認證 API

- **檔案**: `userAuth.test.js`
- **測試內容**:
  - 登入/註冊請求
  - token 處理
  - 錯誤訊息處理
  - 請求攔截器

#### 2.3 菜單 API

- **檔案**: `menu.test.js`
- **測試內容**:
  - 菜單資料請求
  - 快取機制
  - 離線處理
  - 資料更新

### 3. 組件測試 (Components)

`tests/unit/src/components/`

#### 3.1 客戶端組件

- **檔案**: `customer/cart/CartItem.test.vue`
- **測試內容**:

  - 商品資訊顯示
  - 數量調整按鈕
  - 刪除功能
  - 價格計算顯示

- **檔案**: `customer/menu/MenuItemCard.test.vue`
- **測試內容**:
  - 菜品資訊顯示
  - 新增到購物車
  - 選項選擇
  - 圖片載入

#### 3.2 管理端組件

- **檔案**: `BrandAdmin/Order/OrderList.test.vue`
- **測試內容**:

  - 訂單列表顯示
  - 篩選功能
  - 狀態更新
  - 分頁功能

- **檔案**: `BrandAdmin/Inventory/StockDetail.test.vue`
- **測試內容**:
  - 庫存資訊顯示
  - 庫存調整
  - 歷史記錄
  - 警告提示

#### 3.3 櫃台系統組件

- **檔案**: `counter/OrderCart/ShoppingCart.test.vue`
- **測試內容**:
  - POS 購物車顯示
  - 快速操作按鈕
  - 結帳流程
  - 支付選項

### 4. Composables 測試

`tests/unit/src/composables/`

#### 4.1 語言切換

- **檔案**: `useLanguage.test.js`
- **測試內容**:
  - 語言切換功能
  - 本地儲存
  - 預設語言設定
  - 翻譯更新

#### 4.2 權限檢查

- **檔案**: `usePermissions.test.js`
- **測試內容**:
  - 角色權限檢查
  - 動態權限更新
  - 權限快取
  - 無權限處理

---

## 三、整合測試 (Integration Tests)

### 1. API 整合測試

`tests/integration/api/`

#### 1.1 訂單流程整合 ✅

- **檔案**: `order/orderFlow.test.js` ✅
- **測試內容**:
  - ✅ 創建訂單（匿名/已登入用戶）
  - ✅ 錯誤處理（庫存不足、無效資料）
  - ✅ 用戶訂單查詢（認證、分頁）
  - ✅ 單一訂單詳情查詢
  - ✅ 支付處理流程
  - ✅ 支付回調處理
  - ✅ 完整下單到支付流程
  - ✅ 訂單編號生成驗證
  - ✅ API 認證與權限檢查
  - ✅ 錯誤狀態碼與訊息驗證

#### 1.2 認證流程整合

- **檔案**: `auth/authFlow.test.js`
- **測試內容**:
  - 註冊到登入完整流程
  - 會話管理
  - 權限檢查
  - token 更新

### 2. 資料庫整合測試

`tests/integration/database/`

#### 2.1 資料一致性測試

- **檔案**: `dataConsistency.test.js`
- **測試內容**:
  - 關聯資料完整性
  - 事務處理
  - 併發操作
  - 資料回滾

---

## 四、端到端測試 (E2E Tests)

### 1. 客戶端流程

`tests/e2e/customer/`

#### 1.1 下單流程

- **檔案**: `orderFlow.cy.js`
- **測試內容**:
  - 瀏覽菜單
  - 加入購物車
  - 結帳付款
  - 訂單確認

#### 1.2 會員功能

- **檔案**: `memberFeatures.cy.js`
- **測試內容**:
  - 註冊登入
  - 積分使用
  - 優惠券使用
  - 訂單歷史

### 2. 管理端流程

`tests/e2e/admin/`

#### 2.1 訂單管理

- **檔案**: `orderManagement.cy.js`
- **測試內容**:
  - 訂單查看
  - 狀態更新
  - 退款處理
  - 報表查看

#### 2.2 庫存管理

- **檔案**: `inventoryManagement.cy.js`
- **測試內容**:
  - 庫存查看
  - 庫存調整
  - 警告處理
  - 進貨記錄

---

## 五、測試優先級

### 高優先級 (P1)

1. ✅ 庫存管理服務測試 - 完成 (7 tests)
2. ✅ 訂單服務測試（客戶端）- 完成 (9 tests)
3. ✅ 用戶認證服務測試 - 完成 (17 tests)
4. ✅ 購物車狀態測試 - 完成 (35 tests)
5. ✅ 促銷服務測試（兌換券系統）- 完成 (29 tests)
6. ✅ 套餐服務測試（Bundle 系統）- 完成 (36 tests)
7. ✅ 訂單服務測試（管理端）- 完成 (26 tests)
8. ✅ 訂單 API 整合測試 - 完成 (14 tests, 100% 通過)

### 中優先級 (P2)

1. ✅ 管理員認證服務測試 - 完成 (37 tests)
2. ✅ 促銷服務測試（優惠券） - 完成 (29 tests)
3. ✅ 促銷服務測試（積分系統） - 完成 (22 tests)
4. ✅ 庫存統計服務測試 - 完成 (15 tests)
5. ✅ 外送平台服務測試（UberEats 整合） - 完成 (27 tests, 21 passing)
6. ✅ 店鋪管理服務測試 - 完成 (44 tests, 100% 通過)
7. ✅ 菜單服務測試 - 完成 (18 tests, 100% 通過)
8. ✅ 客戶端狀態測試（customerAuth ✅, menu ✅） - 完成 (67 tests, 100% 通過)
9. ✅ POS 系統狀態測試（counter stores） - 完成 (cart ✅ 40 tests, inventory ✅ 30 tests, dishTemplates ✅ 22 tests, orders ✅ 22 tests, modals ✅ 27 tests)
10. 🔄 控制器測試 - 進行中 (orderCustomer ✅ 14 tests, userAuth ✅ 19 tests, inventory ✅ 30 tests, orderAdmin ✅ 11 tests)
11. 認證流程整合測試

### 低優先級 (P3)

1. ✅ 菜品相關服務測試（dishInstance ✅ 23 tests, optionService, optionCategoryService 等）
2. 用戶相關服務測試（userProfile, adminService）
3. 工具與輔助服務測試（image/r2Service, imageHelper）
4. 模型驗證測試
5. 工具函數測試
6. 管理端組件測試
7. 中介軟體測試
8. E2E 測試

---

## 六、測試實作指引

### 測試檔案命名規則

- 服務測試: `{serviceName}.test.js`
- 組件測試: `{ComponentName}.test.vue`
- 整合測試: `{featureName}.test.js`
- E2E 測試: `{featureName}.cy.js`

### 測試資料管理

- 使用 `TestDataFactory` 生成測試資料
- 每個測試前清理資料庫狀態
- 使用 fixtures 管理複雜測試資料

### Mock 策略

- 外部 API 調用使用 MSW
- 資料庫操作使用記憶體資料庫
- 第三方服務使用 Mock

### 測試覆蓋率目標

- 服務層: 90%+
- 控制器層: 85%+
- 組件層: 80%+
- 整體專案: 85%+

---

## 七、注意事項

1. **測試隔離**: 每個測試間要完全獨立，不能有相依性
2. **資料清理**: 測試後要清理所有測試資料
3. **非同步測試**: 正確處理 async/await 和 Promise
4. **錯誤場景**: 不只測試正常流程，也要測試錯誤情況
5. **效能考量**: 測試執行時間要控制在合理範圍內
