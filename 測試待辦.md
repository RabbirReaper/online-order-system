# 測試待辦清單

## 專案測試架構規劃

### 測試類型分類

- **Unit Tests**: 單元測試（services, utils, models）
- **Component Tests**: 組件測試（Vue components）
- **Integration Tests**: 整合測試（API endpoints）
- **E2E Tests**: 端到端測試（完整用戶流程）

---

## 一、後端測試 (Backend Tests)

### 1. 服務層測試 (Services)

`tests/unit/server/services/`

#### 1.1 庫存管理服務 ✅

- **檔案**: `inventory/stockManagement.test.js` ✅
- **測試內容**:
  - 獲取店鋪庫存清單
  - 獲取單個庫存項目
  - 根據菜品模板獲取庫存
  - 庫存篩選功能（類型、可用性）
  - 錯誤處理（找不到項目）

#### 1.2 庫存統計服務 ✅

- **檔案**: `inventory/stockStats.test.js` ✅
- **測試內容**:
  - 庫存統計數據計算
  - 低庫存警告統計
  - 庫存變動趨勢分析
  - 庫存報表生成
- **測試狀態**: 19個測試 (12個通過，7個Mock技術問題)

#### 1.3 訂單服務（客戶端）✅

- **檔案**: `order/orderCustomer.test.js` ✅
- **測試內容**:
  - 訂單金額計算
  - 訂單編號生成
  - 用戶訂單查詢
  - 支付處理
  - 支付回調處理
  - 兌換券發放

#### 1.4 訂單服務（管理端）✅

- **檔案**: `order/orderAdmin.test.js` ✅
- **測試內容**:
  - 訂單查詢與篩選 (getStoreOrders, getUserOrders)
  - 訂單狀態更新 (updateOrder)
  - 取消訂單處理 (cancelOrder)
  - 訂單詳情查詢 (getOrderById)
  - Bundle券生成和點數給予
  - Voucher/Coupon恢復機制

#### 1.4.1 訂單付款服務 ✅

- **檔案**: `order/orderPayment.test.js` ✅
- **測試內容**:
  - **Voucher/Coupon 標記邏輯（markUsedPromotions）**
    - ✅ 空折扣訂單處理（直接返回）
    - ✅ 單個/多個 Voucher 標記（isUsed, usedAt, orderId）
    - ✅ 單個/多個 Coupon 標記（isUsed, usedAt, order）
    - ✅ 跳過已使用的促銷（避免重複標記）
    - ✅ 混合 Voucher 和 Coupon 標記
    - ✅ 部分失敗容錯處理（繼續處理其他項目）
    - ✅ 查詢失敗/不存在處理（不拋出錯誤）
  - **Voucher 還原邏輯（restoreUsedVouchers）**
    - ✅ 成功還原已使用的 Voucher（重置 isUsed, usedAt, orderId）
    - ✅ 拒絕還原已過期的 Voucher
    - ✅ 跳過未使用的 Voucher
    - ✅ 錯誤處理（查詢失敗、不存在）
  - **Coupon 還原邏輯（restoreUsedCoupons）**
    - ✅ 成功還原已使用的 Coupon（重置 isUsed, usedAt, order）
    - ✅ 拒絕還原已過期的 Coupon
    - ✅ 跳過未使用的 Coupon
    - ✅ 錯誤處理（查詢失敗、不存在）
  - **付款完成處理（processOrderPaymentComplete）**
    - ✅ 匿名訂單跳過點數給予
    - ✅ 防止重複給予點數（檢查已存在記錄）
    - ⏭️ Bundle 訂單完整流程（跳過 - 複雜依賴）
  - **廢棄函數向後兼容**
    - ✅ markUsedVouchers 調用 markUsedPromotions
    - ✅ markUsedCoupons 調用 markUsedPromotions
- **測試狀態**: 33個測試 (32個通過，1個跳過 - 複雜依賴需更詳細設置)

#### 1.5 用戶認證服務 ✅

- **檔案**: `user/userAuthService.test.js` ✅
- **測試內容**:
  - **登入功能品牌隔離 (Login - Brand Isolation)** ✅
    - ✅ 正確的手機、密碼和品牌登入成功
    - ✅ 手機存在但品牌不同時登入失敗
    - ✅ 相同手機可在不同品牌存在並分別登入
    - ✅ 缺少品牌參數時拋出錯誤
  - **註冊功能品牌隔離 (Register - Brand Isolation)** ✅
    - ✅ 品牌內手機唯一時註冊成功
    - ✅ 相同手機可在不同品牌註冊
    - ✅ 品牌內手機重複時拒絕註冊
    - ✅ 相同Email可在不同品牌註冊
    - ✅ 品牌內Email重複時拒絕註冊
  - 用戶資料驗證
  - 姓名格式驗證
  - 電話號碼格式驗證
  - Email格式驗證
  - 邊界條件測試
  - 多欄位驗證錯誤處理
- **測試狀態**: 26個測試 (19個通過, 7個跳過 - 新增10個品牌隔離測試，其中7個因mock技術限制跳過)

#### 1.6 管理員認證服務 ✅

- **檔案**: `user/adminAuthService.test.js` ✅
- **測試內容**:
  - 管理員登入（系統管理員 vs 品牌管理員）
  - 權限驗證（品牌權限、系統權限）
  - 會話管理（登入狀態檢查、登出）
  - 角色權限檢查
  - 密碼修改功能
  - 管理員資料更新
  - 各種錯誤情況處理（37個測試案例）

#### 1.7 菜品服務 ✅

- **檔案**: `dish/dishTemplate.test.js` ✅
- **測試內容**:
  - 菜品模板CRUD操作（getAllTemplates, getTemplateById, createTemplate, updateTemplate, deleteTemplate）
  - 菜品選項管理（getTemplateOptions）
  - 菜品分類管理
  - 菜品圖片處理（上傳、更新、刪除）
  - 選項類別驗證與權限檢查
  - 錯誤處理測試（32個測試案例，100% 通過）

#### 1.8 促銷服務 ✅

- **檔案**: `promotion/couponService.test.js` ✅
- **測試內容**:

  - 優惠券模板CRUD操作
  - 優惠券統計計算
  - 優惠券發放邏輯
  - 優惠券使用驗證
  - 權限檢查與錯誤處理
  - 分頁查詢功能（29個測試案例）

- **檔案**: `promotion/pointService.test.js` ✅
- **測試內容**:

  - 積分規則計算
  - 積分累積與扣除
  - 積分兌換功能
  - 積分歷史記錄（22個測試案例）

- **檔案**: `promotion/voucherService.test.js` ✅
- **測試內容**:

  - 兌換券模板CRUD操作
  - 兌換券統計計算
  - 用戶兌換券查詢
  - 兌換券使用驗證
  - 自動創建兌換券模板
  - 權限檢查與錯誤處理（29個測試案例）

#### 1.9 積分規則服務 ✅

- **檔案**: `promotion/pointRuleService.test.js` ✅
- **測試內容**:
  - 點數規則CRUD操作（getAllPointRules, getPointRuleById, createPointRule, updatePointRule, deletePointRule）
  - 啟用點數規則查詢（getActivePointRules）
  - 訂單點數計算邏輯（calculateOrderPoints）
  - 規則驗證與業務邏輯檢查
  - 權限檢查與錯誤處理（25個測試案例，100% 通過）

#### 1.9 店鋪管理服務 ✅

- **檔案**: `store/storeManagement.test.js` ✅
- **測試內容**:
  - 店鋪資訊管理（getAllStores, getStoreById）
  - 店鋪CRUD操作（createStore, updateStore, deleteStore）
  - 營業時間設定（getStoreBusinessHours, updateStoreBusinessHours）
  - 店鋪狀態管理（toggleStoreActive, getStoreCurrentStatus）
  - 配送設定和服務設定（updateStoreServiceSettings）
  - 店鋪公告管理（updateStoreAnnouncements）
- **測試狀態**: 44個測試 (100% 通過)

#### 1.10 菜單服務 ✅

- **檔案**: `store/menuService.test.js` ✅
- **測試內容**:
  - 獲取店鋪所有菜單（包含選項篩選）
  - 根據ID獲取特定菜單
  - 菜單建立與啟用狀態檢查
  - 菜單更新與狀態變更邏輯
  - 菜單刪除功能
  - 錯誤處理（店鋪不存在、菜單不存在）
- **測試狀態**: 18個測試 (100% 通過)

#### 1.11 套餐服務 ✅

- **檔案**: `bundle/bundleService.test.js` ✅
- **測試內容**:
  - Bundle 模板CRUD操作（getAllBundles, getBundleById, createBundle, updateBundle, deleteBundle）
  - Bundle 項目管理與價格計算
  - Bundle 可用性驗證（validateBundlePurchase）
  - Bundle 購買限制檢查（checkPurchaseLimit）
  - 自動創建包裝商品（autoCreateBundlesForVouchers）
  - 圖片處理與關聯餐點驗證
- **測試狀態**: 36個測試 (100% 通過)

- **檔案**: `bundle/bundleInstance.test.js` ✅
- **測試內容**:
  - Bundle 實例CRUD操作（getInstanceById, createInstance, updateInstance, deleteInstance）
  - Bundle 實例使用與點數兌換（redeemBundleWithPoints）
  - Bundle 實例狀態管理與價格計算
  - Bundle 實例與用戶關聯驗證
  - 兌換券生成邏輯（generateVouchersForBundle）
  - 購買限制檢查與錯誤處理
- **測試狀態**: 27個測試 (100% 通過)

#### 1.12 外送平台服務 ✅

- **檔案**: `delivery/ubereatsService.test.js` ✅
- **測試內容**:
  - UberEats API 串接
  - 菜單同步功能
  - 訂單同步處理
  - 錯誤處理與重試
- **測試狀態**: 27個測試 (21個通過，6個因sandbox模式fallback機制問題)

- **檔案**: `delivery/platforms/ubereats/order/orderInventoryValidation.test.js` ✅
- **測試內容**:
  - 主餐點庫存驗證（從 DishInstance 取得 templateId）
  - 關聯餐點庫存驗證（選項中 refDishTemplate 檢查）
  - 庫存統計邏輯（窮舉所有餐點統計數量再一次檢查）
  - 邊界案例處理（無效ID、查詢失敗、無庫存記錄）
  - 庫存狀態檢測（不足、售完、未追蹤等）
- **測試狀態**: 16個測試 (100% 通過)

- **檔案**: `delivery/platforms/ubereats/order/orderInventoryReduction.test.js` ✅
- **測試內容**:
  - 成功扣除流程（單個/批量扣除）
  - 容錯處理（無效ID、無庫存記錄、已售完跳過）
  - 錯誤處理（扣除失敗時錯誤記錄和繼續處理）
  - 庫存還原（取消訂單時還原功能）
  - 單項扣除功能和訂單處理檢查
- **測試狀態**: 21個測試 (100% 通過)

- **檔案**: `delivery/platforms/ubereats/order/orderInventoryIntegration.test.js` ✅
- **測試內容**:
  - 複雜訂單統計（多份套餐包含多種關聯餐點）
  - 混合餐點組合（套餐 + 單點餐點累計邏輯）
  - 邊界案例整合（多種異常情況混合處理）
  - 驗證與扣除流程（完整從驗證到扣除整合）
  - 失敗場景（驗證失敗時阻止庫存扣除）
- **測試狀態**: 7個測試 (100% 通過)

- **檔案**: `delivery/tokenManager.test.js`
- **測試內容**:

  - Token 管理邏輯
  - Token 刷新機制
  - 多店家 Token 管理
  - Token 安全驗證

- **檔案**: `delivery/orderSyncService.test.js`
- **測試內容**:
  - 訂單狀態同步
  - 外送平台訂單處理
  - 同步錯誤處理
  - 數據一致性驗證

#### 1.13 用戶相關服務 ✅

- **檔案**: `user/userProfile.test.js` ✅
- **測試內容**:
  - 用戶資料管理（getUserProfile, getUserById）
  - **個人資訊更新品牌隔離 (updateUserProfile - Brand Isolation)** ✅
    - ✅ Email 更新時檢查品牌內唯一性
    - ✅ Phone 更新時檢查品牌內唯一性
    - ✅ 相同Email可在不同品牌存在
    - ✅ 相同Phone可在不同品牌存在
  - 資料驗證邏輯（updateUserProfile 參數驗證）
  - 個人資訊更新（updateUserProfile, toggleUserStatus）
  - 隱私資料保護（敏感欄位移除）
  - 地址管理（addUserAddress, updateUserAddress, deleteUserAddress, setDefaultAddress）
  - 管理員查詢功能（getAllUsers, getNewUsersInRange）
- **測試狀態**: 36個測試 (100% 通過 - 新增4個品牌隔離測試)

- **檔案**: `user/adminService.test.js` ✅
- **測試內容**:
  - 獲取所有管理員（權限篩選、分頁）
  - 根據ID獲取管理員（權限檢查）
  - 創建管理員（角色驗證、名稱唯一性、主管理員衝突）
  - 更新管理員（權限檢查、資料驗證）
  - 刪除管理員（權限保護、最後管理員保護）
  - 切換管理員狀態（狀態保護）
- **測試狀態**: 28個測試 (100% 通過)

#### 1.14 工具與輔助服務

- **檔案**: `image/r2Service.test.js`
- **測試內容**:

  - 圖片上傳處理
  - 雲端存儲整合
  - 圖片格式驗證
  - 錯誤處理機制

- **檔案**: `imageHelper.test.js`
- **測試內容**:
  - 圖片處理工具
  - 格式轉換功能
  - 圖片壓縮邏輯
  - 批量處理功能

#### 1.15 菜品相關服務 ✅

- **檔案**: `dish/dishInstance.test.js` ✅
- **測試內容**:
  - 獲取所有餐點實例（帶分頁功能）
  - 根據ID獲取餐點實例
  - 創建餐點實例（含選項驗證和價格計算）
  - 更新餐點實例（選項和特殊要求）
  - 刪除餐點實例
  - 餐點最終價格計算邏輯
  - 錯誤處理（模板不存在、選項不存在等）
- **測試狀態**: 23個測試 (100% 通過)

- **檔案**: `dish/optionService.test.js` ✅
- **測試內容**:
  - 獲取選項列表（品牌過濾、類別過濾、標籤過濾）
  - 根據類別ID獲取選項（含排序資訊）
  - 根據ID獲取選項
  - 創建選項（含關聯驗證、名稱唯一性檢查）
  - 更新選項（含驗證邏輯）
  - **刪除選項（重點：依賴檢查邏輯）**
    - ✅ 檢查是否被 optionCategory 引用
    - ✅ 拒絕刪除被引用的選項
    - ✅ 依賴檢查查詢格式驗證
- **測試狀態**: 25個測試 (100% 通過)

- **檔案**: `dish/optionCategoryService.test.js` ✅
- **測試內容**:
  - 獲取所有選項類別（含完整選項詳情）
  - 根據ID獲取類別（可選是否包含選項）
  - 創建類別（含名稱唯一性檢查）
  - 更新類別（含選項驗證、品牌保護）
  - **刪除類別（重點：依賴檢查邏輯）**
    - ✅ 檢查是否被 dishTemplate 使用
    - ✅ 拒絕刪除被使用的類別
    - ✅ mongoose ObjectId 轉換處理
    - ✅ 依賴檢查查詢格式驗證
- **測試狀態**: 23個測試 (100% 通過)

#### 1.16 現金流管理服務 ✅

- **檔案**: `store/cashFlowService.test.js` ✅
- **測試內容**:
  - 獲取店鋪現金流記錄（包含分頁、過濾、搜尋）
  - 根據ID獲取現金流記錄
  - 創建現金流記錄（包含完整驗證邏輯）
  - 更新現金流記錄（類型一致性檢查）
  - 刪除現金流記錄
  - 導出現金流CSV報表
  - 管理員權限驗證
  - 分類與店鋪關聯驗證
- **測試狀態**: 30個測試 (100% 通過)

- **檔案**: `store/cashFlowCategoryService.test.js` ✅
- **測試內容**:
  - 獲取店鋪現金流分類（包含類型過濾）
  - 根據ID獲取分類
  - 創建現金流分類（包含重複名稱檢查）
  - 更新分類（防止修改關鍵欄位）
  - 刪除分類
  - 店鋪與品牌關聯驗證
  - 分類類型驗證（income/expense）
  - 錯誤處理與權限檢查
- **測試狀態**: 18個測試 (17個通過，1個跳過 - constructor mock 技術限制)

### 2. 控制器測試 (Controllers)

`tests/unit/server/controllers/`

#### 2.1 訂單控制器 ✅

- **檔案**: `Order/orderCustomer.test.js` ✅
- **測試內容**:
  - API 請求處理（createOrder, getUserOrders, getUserOrderById, processPayment, paymentCallback）
  - 參數驗證（路由參數、查詢參數、請求體）
  - 響應格式（成功響應、錯誤響應）
  - 錯誤處理（404 訂單不存在）
  - 認證處理（已登入用戶 vs 匿名用戶）
  - 分頁參數處理（默認值、無效值）
- **測試狀態**: 14個測試 (100% 通過)

#### 2.2 用戶控制器 ✅

- **檔案**: `User/userAuth.test.js` ✅
- **測試內容**:
  - 用戶註冊 API（包含手機驗證碼驗證）
  - 用戶登入/登出 API
  - 手機驗證碼發送與驗證
  - 忘記密碼與重設密碼流程
  - 修改密碼功能
  - 用戶登入狀態檢查
  - 參數驗證（路由參數、請求體）
  - 響應格式驗證
  - 錯誤處理機制
  - 會話管理（login/logout）
- **測試狀態**: 19個測試 (100% 通過)

#### 2.3 庫存控制器 ✅

- **檔案**: `Store/inventory.test.js` ✅
- **測試內容**:
  - 獲取店鋪庫存列表（包含查詢過濾）
  - 獲取單個庫存項目
  - 創建庫存項目
  - 更新庫存項目
  - 設定可用庫存
  - 減少庫存（訂單消耗）
  - 增加庫存
  - 損耗處理
  - 初始化餐點庫存
  - 切換售完狀態
  - 獲取庫存變更日誌
  - 獲取項目庫存統計
  - 獲取庫存健康狀況報告
  - 批量更新庫存
  - 獲取庫存變更摘要
  - 參數驗證與錯誤處理
- **測試狀態**: 30個測試 (100% 通過)

#### 2.4 訂單管理控制器 ✅

- **檔案**: `Order/orderAdmin.test.js` ✅
- **測試內容**:
  - 獲取店鋪訂單列表（getStoreOrders）- 包含篩選條件和分頁參數
  - 獲取特定用戶訂單列表（getUserOrders）- 管理員功能，支援排序
  - 獲取訂單詳情（getOrderById）- 後台詳情查詢
  - 更新訂單（updateOrder）- 統一接口，支援混合購買獎勵
  - 取消訂單（cancelOrder）- 包含原因驗證和錯誤處理
  - 參數驗證（查詢參數、路由參數、請求體）
  - 響應格式驗證（成功響應、錯誤響應）
  - 錯誤處理（缺少必填參數）
  - 認證處理（管理員ID驗證）
  - 分頁參數處理（默認值、無效值）
- **測試狀態**: 11個測試 (100% 通過)

### 3. 中介軟體測試 (Middlewares)

`tests/unit/server/middlewares/`

#### 3.1 認證中介軟體

- **檔案**: `auth/authentication.test.js`
- **測試內容**:
  - JWT token 驗證
  - 會話檢查
  - 用戶狀態驗證
  - 錯誤處理

#### 3.2 授權中介軟體

- **檔案**: `auth/authorization.test.js`
- **測試內容**:
  - 角色權限檢查
  - 店鋪權限驗證
  - 功能權限檢查
  - 拒絕存取處理

#### 3.3 驗證中介軟體

- **檔案**: `validator.test.js`
- **測試內容**:
  - 輸入參數驗證
  - 資料格式檢查
  - 必填欄位驗證
  - 自定義驗證規則

### 4. 模型測試 (Models)

`tests/unit/server/models/`

#### 4.1 用戶模型

- **檔案**: `User/User.test.js`
- **測試內容**:
  - 資料驗證規則
  - 密碼加密
  - 虛擬屬性
  - 模型方法

#### 4.2 訂單模型

- **檔案**: `Order/Order.test.js`
- **測試內容**:
  - 訂單編號生成
  - 金額計算
  - 狀態轉換規則
  - 關聯資料

#### 4.3 庫存模型

- **檔案**: `Store/Inventory.test.js`
- **測試內容**:
  - 庫存數量驗證
  - 閾值檢查
  - 自動更新邏輯
  - 索引設定

### 5. 工具函數測試 (Utils)

`tests/unit/server/utils/`

#### 5.1 日期工具

- **檔案**: `date.test.js`
- **測試內容**:
  - 日期格式化
  - 時區轉換
  - 日期計算
  - 有效性檢查

---

## 二、前端測試 (Frontend Tests)

### 1. 狀態管理測試 (Stores)

`tests/unit/src/stores/`

#### 1.1 購物車狀態 ✅

- **檔案**: `cart.test.js` ✅
- **測試內容**:
  - 初始狀態管理
  - 品牌和店鋪管理
  - 訂單類型管理
  - 客戶資訊管理
  - 商品項目管理（菜品/套餐）
  - 優惠券管理
  - 支付方式設定
  - 總金額計算邏輯
  - 訂單驗證
  - 購物車清理

#### 1.2 客戶認證狀態 ✅

- **檔案**: `customerAuth.test.js` ✅
- **測試內容**:
  - 登入/登出狀態
  - 用戶資訊儲存
  - 品牌ID管理與sessionStorage同步
  - 註冊功能（包含驗證）
  - 登入功能（多種資料結構支援）
  - 登出功能（含錯誤處理）
  - 檢查登入狀態（含自動恢復）
  - 重設密碼功能
  - 修改密碼功能
  - 獲取用戶資料
  - 初始化與自動檢查
  - 計算屬性（userName, userId, currentBrandId）
  - 錯誤處理機制
- **測試狀態**: 44個測試 (100% 通過)

#### 1.3 菜單狀態 ✅

- **檔案**: `menu.test.js` ✅
- **測試內容**:
  - 初始狀態管理（currentMenuType, brandId, storeId）
  - 菜單類型設定（setMenuType）
  - 品牌店鋪設定（setBrandAndStore）
  - 計算屬性（menuTypeText, requiresAuth）
  - sessionStorage持久化（persistState, restoreState）
  - 狀態清除（clearState）
  - 錯誤處理機制
  - 複合操作與數據一致性驗證
- **測試狀態**: 23個測試 (100% 通過)

#### 1.4 櫃台系統狀態 ✅

- **檔案**: `counter/cart.test.js` ✅
- **測試內容**:
  - POS 購物車管理（初始狀態、添加菜品/套餐）
  - 購物車項目管理（移除、數量更新、編輯）
  - 價格調整（手動調帳、折扣）
  - 計算屬性（小計、總計）
  - 購物車清理和取消訂單
  - 項目合併邏輯
  - 結帳功能（訂單提交、錯誤處理）
- **測試狀態**: 40個測試 (100% 通過)

- **檔案**: `counter/inventory.test.js` ✅
- **測試內容**:
  - 初始狀態管理（inventoryData, isLoadingInventory）
  - 庫存資訊獲取（getInventoryInfo）
  - 菜品售完狀態檢查（isDishSoldOut）- 包含手動設定和庫存檢查邏輯
  - 庫存徽章樣式（getStockBadgeClass）- 不同庫存狀況顯示不同顏色
  - 庫存資料載入（loadInventoryData）- API 整合與錯誤處理
  - 庫存資料清理（clearInventoryData）
  - 邊界條件和異常處理（負數、浮點數、無效資料）
- **測試狀態**: 30個測試 (100% 通過)

- **檔案**: `counter/dishTemplates.test.js` ✅
- **測試內容**:
  - POS 菜品模板管理（fetchDishTemplates, fetchOptionCategoriesWithOptions）
  - 菜單資料載入與排序邏輯（fetchMenuData）
  - 餐點模板查詢功能（getDishTemplate）
  - 預設選項生成邏輯（getDefaultOptionsForDish）
  - API 錯誤處理與邊界條件測試
- **測試狀態**: 22個測試 (100% 通過)

- **檔案**: `counter/orders.test.js` ✅
- **測試內容**:
  - 初始狀態管理（todayOrders, selectedOrder, currentDate）
  - 訂單計算方法（小計、折扣、總計）
  - API 操作（載入當日訂單、按日期查詢訂單）
  - 訂單操作（選擇訂單、清空狀態）
  - 格式化方法重新導出驗證
  - 錯誤處理與日誌記錄
- **測試狀態**: 22個測試 (100% 通過)

- **檔案**: `counter/modals.test.js` ✅
- **測試內容**:
  - POS 彈窗狀態管理（初始狀態、模態框開啟關閉）
  - 調帳彈窗邏輯（新增調帳、編輯訂單調帳、計算功能）
  - 結帳彈窗邏輯（開啟結帳、狀態重置）
  - 現金計算器和桌號彈窗處理
  - 通用彈窗關閉和狀態管理完整性
- **測試狀態**: 27個測試 (100% 通過)

### 2. API 模組測試 (API Modules)

`tests/unit/src/api/modules/`

#### 2.1 訂單 API

- **檔案**: `orderCustomer.test.js`
- **測試內容**:
  - API 請求格式
  - 響應處理
  - 錯誤處理
  - 重試機制

#### 2.2 認證 API

- **檔案**: `userAuth.test.js`
- **測試內容**:
  - 登入/註冊請求
  - token 處理
  - 錯誤訊息處理
  - 請求攔截器

#### 2.3 菜單 API

- **檔案**: `menu.test.js`
- **測試內容**:
  - 菜單資料請求
  - 快取機制
  - 離線處理
  - 資料更新

### 3. 組件測試 (Components)

`tests/unit/src/components/`

#### 3.1 客戶端組件

- **檔案**: `customer/LineEntry.test.js` ✅
- **測試內容**:
  - LIFF 初始化流程
  - 登入狀態檢查
  - 參數解析和驗證
  - 購物車上下文設定
  - 路由跳轉邏輯
  - 錯誤處理和用戶互動
  - 載入狀態管理
  - 環境檢查（LINE App 檢測）
  - 錯誤邊界處理
- **測試狀態**: 20個測試 (100% 通過)

- **檔案**: `customer/dishDetail/OptionSelector.test.js` ✅
- **測試內容**:
  - 初始狀態管理（單選/多選預設值、數量初始化）
  - **庫存檢查功能**（關聯餐點檢查、載入狀態處理、售罄/零庫存禁用邏輯）
  - 編輯模式處理（載入現有資料、多選選項處理）
  - 數量控制（增減數量、最小值限制）
  - 價格計算（基礎價格、選項價格、多選價格、數量計算）
  - 選項詳情生成（單選/多選詳情格式）
  - 事件發射（加入購物車、確認修改）
  - UI 渲染（選項顯示、按鈕狀態、CSS 類別、禁用狀態）
  - 響應式行為（props 變化、狀態重置）
  - 錯誤處理（無效資料、缺少選項）
- **測試狀態**: 35個測試 (100% 通過)

- **檔案**: `customer/cart/CartItem.test.vue`
- **測試內容**:

  - 商品資訊顯示
  - 數量調整按鈕
  - 刪除功能
  - 價格計算顯示

- **檔案**: `customer/menu/MenuItemCard.test.vue`
- **測試內容**:
  - 菜品資訊顯示
  - 新增到購物車
  - 選項選擇
  - 圖片載入

#### 3.2 管理端組件

- **檔案**: `BrandAdmin/Order/OrderList.test.vue`
- **測試內容**:

  - 訂單列表顯示
  - 篩選功能
  - 狀態更新
  - 分頁功能

- **檔案**: `BrandAdmin/Inventory/StockDetail.test.vue`
- **測試內容**:
  - 庫存資訊顯示
  - 庫存調整
  - 歷史記錄
  - 警告提示

#### 3.3 櫃台系統組件

- **檔案**: `counter/OrderCart/ShoppingCart.test.vue`
- **測試內容**:
  - POS 購物車顯示
  - 快速操作按鈕
  - 結帳流程
  - 支付選項

### 4. Composables 測試

`tests/unit/src/composables/`

#### 4.1 語言切換

- **檔案**: `useLanguage.test.js`
- **測試內容**:
  - 語言切換功能
  - 本地儲存
  - 預設語言設定
  - 翻譯更新

#### 4.2 權限檢查

- **檔案**: `usePermissions.test.js`
- **測試內容**:
  - 角色權限檢查
  - 動態權限更新
  - 權限快取
  - 無權限處理

---

## 三、整合測試 (Integration Tests)

### 1. API 整合測試

`tests/integration/api/`

#### 1.1 訂單流程整合 ✅

- **檔案**: `order/orderFlow.test.js` ✅
- **測試內容**:
  - ✅ 創建訂單（匿名/已登入用戶）
  - ✅ 錯誤處理（庫存不足、無效資料）
  - ✅ 用戶訂單查詢（認證、分頁）
  - ✅ 單一訂單詳情查詢
  - ✅ 支付處理流程
  - ✅ 支付回調處理
  - ✅ 完整下單到支付流程
  - ✅ 訂單編號生成驗證
  - ✅ API 認證與權限檢查
  - ✅ 錯誤狀態碼與訊息驗證

#### 1.2 認證流程整合 ✅

- **檔案**: `auth/authFlow.test.js` ✅
- **測試內容**:
  - ✅ 註冊到登入完整流程（發送驗證碼→驗證→註冊）
  - ✅ 用戶與管理員登入/登出流程
  - ✅ 會話管理生命週期
  - ✅ 權限檢查和認證中介軟體
  - ✅ 密碼管理（忘記密碼、重設、修改）
- **測試狀態**: 17個測試 (4個通過，13個需要調整mock設置)

### 2. 資料庫整合測試

`tests/integration/database/`

#### 2.1 資料一致性測試

- **檔案**: `dataConsistency.test.js`
- **測試內容**:
  - 關聯資料完整性
  - 事務處理
  - 併發操作
  - 資料回滾

---

## 四、端到端測試 (E2E Tests)

### 1. 客戶端流程

`tests/e2e/customer/`

#### 1.1 下單流程

- **檔案**: `orderFlow.cy.js`
- **測試內容**:
  - 瀏覽菜單
  - 加入購物車
  - 結帳付款
  - 訂單確認

#### 1.2 會員功能

- **檔案**: `memberFeatures.cy.js`
- **測試內容**:
  - 註冊登入
  - 積分使用
  - 優惠券使用
  - 訂單歷史

### 2. 管理端流程

`tests/e2e/admin/`

#### 2.1 訂單管理

- **檔案**: `orderManagement.cy.js`
- **測試內容**:
  - 訂單查看
  - 狀態更新
  - 退款處理
  - 報表查看

#### 2.2 庫存管理

- **檔案**: `inventoryManagement.cy.js`
- **測試內容**:
  - 庫存查看
  - 庫存調整
  - 警告處理
  - 進貨記錄

---

## 五、測試優先級

### 高優先級 (P1)

1. ✅ 庫存管理服務測試 - 完成 (7 tests)
2. ✅ 訂單服務測試（客戶端）- 完成 (9 tests)
3. ✅ 用戶認證服務測試 - 完成 (26 tests, 19 passed, 7 skipped - 新增10個品牌隔離測試)
4. ✅ 購物車狀態測試 - 完成 (35 tests)
5. ✅ 促銷服務測試（兌換券系統）- 完成 (29 tests)
6. ✅ 套餐服務測試（Bundle 系統）- 完成 (36 tests)
7. ✅ 訂單服務測試（管理端）- 完成 (26 tests)
8. ✅ 訂單付款服務測試 - 完成 (33 tests, 32 passing, 1 skipped)
9. ✅ 訂單 API 整合測試 - 完成 (14 tests, 100% 通過)

### 中優先級 (P2)

1. ✅ 管理員認證服務測試 - 完成 (37 tests)
2. ✅ 促銷服務測試（優惠券） - 完成 (29 tests)
3. ✅ 促銷服務測試（積分系統） - 完成 (22 tests)
4. ✅ 庫存統計服務測試 - 完成 (15 tests)
5. ✅ 外送平台服務測試（UberEats 整合） - 完成 (27 tests, 21 passing)
6. ✅ 店鋪管理服務測試 - 完成 (44 tests, 100% 通過)
7. ✅ 菜單服務測試 - 完成 (18 tests, 100% 通過)
8. ✅ 現金流管理服務測試 - 完成 (cashFlowService ✅ 30 tests, cashFlowCategoryService ✅ 18 tests - 17 passing, 1 skipped)
9. ✅ 客戶端狀態測試（customerAuth ✅, menu ✅） - 完成 (67 tests, 100% 通過)
10. ✅ POS 系統狀態測試（counter stores） - 完成 (cart ✅ 40 tests, inventory ✅ 30 tests, dishTemplates ✅ 22 tests, orders ✅ 22 tests, modals ✅ 27 tests)
11. 🔄 控制器測試 - 進行中 (orderCustomer ✅ 14 tests, userAuth ✅ 19 tests, inventory ✅ 30 tests, orderAdmin ✅ 11 tests)
12. ✅ 認證流程整合測試 - 完成 (17 tests, 4 passing - 需要調整mock設置)

### 低優先級 (P3)

1. ✅ 菜品相關服務測試（dishInstance ✅ 23 tests, optionService ✅ 25 tests, optionCategoryService ✅ 23 tests）
2. ✅ 客戶端組件測試（LineEntry.vue ✅ 20 tests）
3. ✅ 用戶相關服務測試（userProfile ✅ 36 tests - 新增4個品牌隔離測試, adminService ✅ 28 tests）
4. 工具與輔助服務測試（image/r2Service, imageHelper）
5. 模型驗證測試
6. 工具函數測試
7. 管理端組件測試
8. 中介軟體測試
9. E2E 測試

---

## 六、測試實作指引

### 測試檔案命名規則

- 服務測試: `{serviceName}.test.js`
- 組件測試: `{ComponentName}.test.vue`
- 整合測試: `{featureName}.test.js`
- E2E 測試: `{featureName}.cy.js`

### 測試資料管理

- 使用 `TestDataFactory` 生成測試資料
- 每個測試前清理資料庫狀態
- 使用 fixtures 管理複雜測試資料

### Mock 策略

- 外部 API 調用使用 MSW
- 資料庫操作使用記憶體資料庫
- 第三方服務使用 Mock

### 測試覆蓋率目標

- 服務層: 90%+
- 控制器層: 85%+
- 組件層: 80%+
- 整體專案: 85%+

---

## 七、注意事項

1. **測試隔離**: 每個測試間要完全獨立，不能有相依性
2. **資料清理**: 測試後要清理所有測試資料
3. **非同步測試**: 正確處理 async/await 和 Promise
4. **錯誤場景**: 不只測試正常流程，也要測試錯誤情況
5. **效能考量**: 測試執行時間要控制在合理範圍內
